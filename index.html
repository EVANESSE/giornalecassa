<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa (Corretta e Stabile)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #6c757d;
            --primary-color-light: #f8f9fa;
        }
        body.theme-allianz { --primary-color: #007bff; --primary-color-light: #cce5ff; }
        body.theme-hdi { --primary-color: #28a745; --primary-color-light: #d4edda; }
        body.theme-vittoria { --primary-color: #6f42c1; --primary-color-light: #e2d9f3; }
        body.theme-arag { --primary-color: #ffc107; --primary-color-light: #fff3cd; }
        body.theme-helvetia { --primary-color: #dc3545; --primary-color-light: #f8d7da; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto; background: #fff; padding: 25px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;
        }
        h1, h2, h3 { color: var(--primary-color); }
        h1 { border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .box { padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; }
        
        input, select, button {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem;
        }
        button {
            background-color: var(--primary-color); color: white; border: none;
            cursor: pointer; font-weight: bold; transition: background-color 0.2s;
        }
        button.button-save { background-color: #28a745; font-size: 1.1rem; padding: 12px;}
        button:hover { filter: brightness(90%); }
        button:disabled, fieldset:disabled button { background-color: #ccc; cursor: not-allowed; }
        fieldset { border: none; padding: 0; margin: 0; }
        fieldset:disabled { opacity: 0.6; }
        .button-secondary { background-color: #6c757d; }
        .button-edit { background-color: #ffc107; color: #212529; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}
        .button-delete { background-color: #dc3545; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; table-layout: fixed; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; word-wrap: break-word; }
        th { background-color: var(--primary-color-light); }
        .provvigione-editabile:hover { background-color: #fff3cd; cursor: pointer; }
        
        .riepilogo-totali, .risultato-verifica {
            font-size: 1.2rem; font-weight: bold; padding: 15px; margin-top: 15px;
            border-radius: 5px; background-color: var(--primary-color-light); border-left: 5px solid var(--primary-color);
        }
        .risultato-verifica.ok { color: #155724; background-color: #d4edda; border-left-color: #28a745; }
        .risultato-verifica.errore { color: #721c24; background-color: #f8d7da; border-left-color: #dc3545; }
        
        .decade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .decade-grid div { padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .decade-grid strong { color: var(--primary-color); }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; 
            justify-content: center; align-items: center; z-index: 1000;
        }
        
        #company-selector-modal .modal-overlay-background {
            background: radial-gradient(circle, #6c757d 0%, #212529 100%);
            backdrop-filter: blur(3px);
        }
        #company-selector-modal .modal-wrapper {
            display: flex; gap: 40px; align-items: flex-start;
        }
        #company-selector-modal .modal-content {
            background: linear-gradient(to bottom, #f8f9fa, #ffffff); border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 30px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #company-selector-modal .company-button {
            width: 300px; margin: 15px 0; font-weight: bold; padding: 30px 10px;
            border-bottom: 3px solid rgba(0,0,0,0.25); border-radius: 8px;
            background-image: linear-gradient(to top, rgba(0,0,0,0.2), transparent 40%);
            transition: all 0.2s ease-in-out; font-size: 1.4rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        #company-selector-modal .company-button:hover {
            transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.35); filter: brightness(1.1);
        }
        
        #utility-section {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        .utility-grid-container {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; padding: 20px;
        }
        .utility-button {
            width: 150px; height: 150px;
            margin: 0; padding: 10px;
            border-radius: 15px; border: 1px solid #b0b0b0;
            background: linear-gradient(145deg, #f0f0f0, #cacaca);
            box-shadow: 7px 7px 15px #babecc, -7px -7px 15px #ffffff;
            color: #333; text-shadow: 1px 1px 1px #fff;
            font-size: 1rem; font-weight: bold;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 10px; cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .utility-button:hover {
            box-shadow: 4px 4px 10px #babecc, -4px -4px 10px #ffffff;
            transform: scale(0.98);
            color: #007bff;
        }
        .utility-button:active {
            box-shadow: inset 5px 5px 10px #babecc, inset -5px -5px 10px #ffffff;
            transform: scale(0.95);
            color: #28a745;
        }
        .utility-button i {
            color: #555; transition: color 0.2s ease-in-out;
        }
        .utility-button:hover i { color: #007bff; }
        .utility-button:active i { color: #28a745; }
        
        .utility-button-full-width {
            grid-column: 1 / -1; 
            width: auto;         
            height: 80px;        
        }

        .backup-container {
            position: absolute; top: 30px; right: 40px;
            z-index: 1001; display: flex; gap: 10px;
        }
        .header-backup-button {
            width: auto; padding: 8px 15px; font-size: 0.9rem;
            background-color: #17a2b8; border-radius: 5px; margin-bottom: 0;
        }

        .modal-full { padding: 20px; align-items: flex-start; overflow-y: auto; }
        .modal-full .modal-content-full {
            width: 95%; max-width: 1800px; background: #fff;
            padding: 20px; border-radius: 8px; text-align: left; margin-top: 2vh;
        }
        .modal-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 2px solid #ccc; margin-bottom: 15px;
            flex-wrap: wrap; gap: 15px;
        }
        .modal-toolbar .filter-group { display: flex; align-items: center; gap: 10px; }
        .modal-toolbar .action-group { display: flex; align-items: center; gap: 10px; }
        .modal-toolbar .filter-group button, .modal-toolbar .filter-group select, .modal-toolbar .filter-group input, .modal-toolbar .action-group button { 
            width: auto; margin-bottom: 0; padding: 8px;
        }
        .generic-table td[contenteditable="true"]:hover { background-color: #fff3cd; cursor: text; }
        .generic-table input, .generic-table select { padding: 4px; font-size: 0.9rem; border-radius: 3px; border: 1px solid #ccc;}
        .generic-table input[type="checkbox"] { width: auto; transform: scale(1.2); }
        .generic-table th.col-note, .generic-table td.col-note { width: 25%; }
        
        .riga-incassato { background-color: #d4edda !important; text-decoration: line-through; color: #555;}
        .riga-vecchio { background-color: #fff3cd; }
        .riga-critico { background-color: #f8d7da; }

        .save-notification {
            display: none; padding: 10px 15px; border-radius: 5px; text-align: center;
            font-weight: bold; margin: -10px auto 10px auto;
            opacity: 0; transition: opacity 0.5s ease-in-out;
            color: white;
        }
        .save-notification.success { background-color: #28a745; }
        .save-notification.error { background-color: #dc3545; }
        
        .app-header { 
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; 
            padding: 10px 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; gap: 10px;
        }
        .app-header .header-group { display: flex; align-items: center; gap: 10px; }
        
        #status-indicator { font-weight: bold; padding: 5px 10px; border-radius: 5px; color: white; }
        #status-indicator.synced { background-color: #28a745; }
        #status-indicator.saving { background-color: #ffc107; color: black; }
        #status-indicator.error { background-color: #dc3545; }

        .col-data-mensile { display: none; }
        body.vista-mensile .col-data-mensile { display: table-cell; }
        body.vista-mensile .col-impatto-cassa, body.vista-mensile .col-cassa-teorica { display: none; }
        
        #add-movimento-form label { 
            font-weight: bold; margin-top: 15px; 
            font-size: 1.1rem; display: block; color: #333;
        }
        #add-movimento-title { font-size: 1.8rem; color: #333; }

        #divIncassoMultiplo { border: 2px dashed var(--primary-color); padding: 15px; margin-top: 15px; border-radius: 5px; }
        #divIncassoMultiplo hr { margin: 20px 0; }
        
        .riporto-toggle-container {
            display: flex; align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .switch-label {
            font-weight: bold; color: var(--primary-color);
        }
        .switch {
            position: relative; display: inline-block;
            width: 60px; height: 34px;
        }
        .switch input { 
            opacity: 0; width: 0; height: 0;
        }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute; content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider { background-color: #28a745; }
        input:not(:checked) + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            body > *:not(#print-layout) { display: none !important; }
            #print-layout { display: block !important; font-family: Arial, sans-serif; color: #000; }
            #print-page-1, #print-page-2 { width: 100%; padding: 20mm 15mm; box-sizing: border-box; }
            #print-page-2 {
                page-break-before: always;
                display: flex; flex-direction: column;
                justify-content: space-between; height: 257mm;
            }
            .simplified-print #print-verifica-container { display: none !important; }
            #print-header {
                text-align: center; border-bottom: 2px solid #333;
                padding-bottom: 15px; margin-bottom: 20px; font-size: 1.5rem; color: #000;
            }
            #print-table-container table { width: 100%; font-size: 10pt; border-collapse: collapse; }
            #print-table-container th, #print-table-container td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            #print-table-container th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            #print-conteggio-container, #print-verifica-container { margin-top: 20px; }
            #print-conteggio-container h2, #print-conteggio-container h3 {
                color: #000; border-bottom: 1px solid #ccc; padding-bottom: 5px;
            }
            #print-conteggio-container .conteggio-grid {
                display: grid; grid-template-columns: 1fr 2fr 2fr; 
                align-items: center; gap: 5px; padding: 5px 0; border-bottom: 1px dotted #eee;
            }
            #print-conteggio-container input { display: none; }
            #print-conteggio-container label { font-weight: bold; }
            #print-conteggio-container .riepilogo-totali {
                font-size: 1.3rem; margin-top: 20px; background: #f0f0f0 !important;
                border: 1px solid #ccc; -webkit-print-color-adjust: exact; color-adjust: exact;
            }
            #print-verifica-container .risultato-verifica {
                font-size: 1.4rem; padding: 20px; text-align: center;
                border: 2px solid #333; border-radius: 5px;
            }
            #print-verifica-container .risultato-verifica.ok {
                background-color: #d4edda !important; color: #155724 !important;
                -webkit-print-color-adjust: exact; color-adjust: exact;
            }
            #print-verifica-container .risultato-verifica.errore {
                background-color: #f8d7da !important; color: #721c24 !important;
                -webkit-print-color-adjust: exact; color-adjust: exact;
            }
        }
    </style>
</head>
<body id="app-body">
    <div class="modal-overlay" id="company-selector-modal">
        <div class="modal-overlay-background"></div>

        <div class="backup-container">
            <button class="header-backup-button" onclick="esportaBackup()"><i class="fa fa-download"></i> Esporta</button>
            <button class="header-backup-button" onclick="importaBackup()"><i class="fa fa-upload"></i> Importa</button>
        </div>

        <div class="modal-wrapper">
     
            <div class="modal-content">
                <h2>Seleziona la Compagnia</h2>
                <button class="company-button" onclick="inizializzaApp('Allianz')" style="background-color:#007bff">Allianz</button>
                <button class="company-button" onclick="inizializzaApp('HDI')" style="background-color:#28a745">HDI</button>
                <button class="company-button" onclick="inizializzaApp('Vittoria')" style="background-color:#6f42c1">Vittoria</button>
                <button class="company-button" onclick="inizializzaApp('ARAG')" style="background-color:#ffc107">ARAG</button>
                <button class="company-button" onclick="inizializzaApp('Helvetia')" style="background-color:#dc3545">Helvetia</button>
            </div>
           
            <div class="modal-content" id="utility-section">
                <h2>Altre Funzioni</h2>
                <div class="utility-grid-container">
                    <button class="utility-button" onclick="mostraTabella('anticipi')">
                        <i class="fas fa-hand-holding-usd fa-2x"></i>
                        <span>ANTICIPO</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('bonifici_allianz')">
                        <i class="fas fa-university fa-2x"></i>
                        <span>BONIFICI ALLIANZ</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('bonifici_hdi_arag')">
                        <i class="fas fa-exchange-alt fa-2x"></i>
                        <span>BONIFICI HDI/ARAG</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('pos_hdi_arag')">
                        <i class="far fa-credit-card fa-2x"></i>
                        <span>POS HDI/ARAG</span>
                    </button>
                    <button class="utility-button utility-button-full-width" onclick="mostraTabella('abbuoni')">
                        <i class="fas fa-tags fa-2x"></i>
                        <span>ABBUONI</span>
                    </button>
                </div>
            </div>
     
       </div>
  
    </div>
    
    <div class="modal-overlay modal-full" id="generic-modal" style="display:none;">
        <div class="modal-content-full">
            <div class="modal-toolbar">
                <h2 id="generic-modal-title"></h2>
                <div class="filter-group">
                    <label>Filtra per:</label>
                    <select id="generic-filtro-anno"></select>
                    <select id="generic-filtro-mese"></select>
                    <input type="date" id="generic-filtro-giorno">
                    <input type="text" id="generic-filtro-testo" placeholder="Cerca..." style="display: none;">
                    <button onclick="applicaFiltriTabella()">Applica Filtri</button>
                    <button class="button-secondary" onclick="resetFiltriTabella()">Resetta</button>
                </div>
                <div class="action-group">
                    <button class="button-save" onclick="apriFormAggiunta()"><i class="fa fa-plus"></i> Aggiungi Movimento</button>
                    <button class="button-save" onclick="salvaTutteLeModificheTabella()">Salva Modifiche</button>
                    <button class="button-secondary" onclick="document.getElementById('generic-modal').style.display = 'none'">Chiudi</button>
                </div>
             </div>
            <div id="generic-modal-notification" class="save-notification"></div>
            <div style="overflow-x: auto;">
                <table id="generic-table" class="generic-table">
                   <thead></thead>
                   <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-movimento-modal" style="display:none; z-index: 1001;">
        <div class="modal-content" style="text-align: left; width: 450px; padding: 30px;">
            <h2 id="add-movimento-title" style="text-align: center;">Aggiungi Nuovo Movimento</h2>
            <form id="add-movimento-form" onsubmit="event.preventDefault(); processaFormAggiunta();"></form>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="processaFormAggiunta()" class="button-save" style="width: 50%;">Salva</button>
                <button type="button" class="button-secondary" style="width: 50%;" onclick="document.getElementById('add-movimento-modal').style.display = 'none'">Annulla</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-container">
        <h1 id="main-title">Registro Cassa</h1>
        
        <div class="app-header">
            <div class="header-group">
                <label for="date-selector">Visualizza movimenti del:</label>
                <input type="date" id="date-selector" onchange="caricaGiornale(this.valueAsDate)">
            </div>
            <div class="header-group">
                 <div id="status-indicator"></div>
                <button onclick="salvaStatoCorrente()" class="button-save">Salva Modifiche Online</button>
                <button onclick="stampaPersonalizzata()" class="button-secondary">Stampa</button>
                <button id="btn-festa" class="button-secondary" style="display: none;">Festa/Chiusura</button>
                <button onclick="location.reload()">Chiudi</button>
            </div>
         </div>
    
       
        <div class="box" id="box-inizio-giornata">
            <h2>1. Inizio Giornata</h2>
            <div class="riporto-toggle-container">
                <label for="riporto-mode-toggle" class="switch-label" id="riporto-mode-label">Riporto Automatico</label>
                <label class="switch">
                    <input type="checkbox" id="riporto-mode-toggle" onchange="toggleRiportoMode(this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>
            <label for="riportoIniziale"><strong>Riporto da Cassa Teorica Giorno Precedente (€):</strong></label>
            <input type="number" id="riportoIniziale" placeholder="0.00" step="0.01" oninput="aggiornaTuttiRiepiloghi()">
        </div>
    
        <div class="grid-container">
            <fieldset id="form-movimento-fieldset">
                <div class="box">
                    <h2 id="form-title">2. Registrazione Movimento</h2>
                    <form id="formMovimento" onsubmit="event.preventDefault(); processaFormMovimento();">
                        <input type="hidden" id="editingIndex" value="">
                        <label for="metodologia">Metodologia Incasso:</label>
                        <select id="metodologia" onchange="aggiornaCampiCondizionali()"></select>
                        
                        <div id="divVersamento" style="display:none;">
                            <label for="versamentoContanti">Versamento Contanti (€):</label>
                            <input type="number" id="versamentoContanti" step="0.01" placeholder="0.00">
                            <label for="versamentoAssegni">Versamento Assegni (€):</label>
                            <input type="number" id="versamentoAssegni" step="0.01" placeholder="0.00">
                        </div>

                        <div id="campi-standard">
                             <div id="divTipoPosAllianz" style="display:none;">
                                <label for="tipoPosAllianz">Tipo POS:</label>
                                <select id="tipoPosAllianz">
                                   <option value="POS Direzione">POS Direzione</option>
                                    <option value="POS Agenzia">POS Agenzia</option>
                                </select>
                            </div>
                            <div id="divTipoAnticipo" style="display:none;">
                                <label for="tipoAnticipo">Tipo Anticipo:</label>
                                <select id="tipoAnticipo" onchange="aggiornaCampiCondizionali()">
                                    <option value="Anticipo Contanti">Anticipo Contanti</option>
                                    <option value="Anticipo Assegno">Anticipo Assegno</option>
                                    <option value="Anticipo POS">Anticipo POS</option>
                                    <option value="Anticipo Bonifico">Anticipo Bonifico</option>
                                    <option value="Plafond">Plafond</option>
                                    <option value="Sospeso Cassa">Sospeso Cassa</option>
                                </select>
                            </div>
                    
                            <div id="divRientroMetodo" style="display:none;">
                                <label for="rientroMetodo">Metodo di Rientro:</label>
                                <select id="rientroMetodo" onchange="aggiornaCampiCondizionali()">
                                    <option value="Contanti">Contanti</option><option value="Assegno">Assegno</option>
                                    <option value="POS">POS</option><option value="Bonifico">Bonifico</option>
                                </select>
                            </div>
                            <div id="divNumeroAssegno" style="display:none;">
                                <label for="numeroAssegno">Numero Assegno:</label>
                                <input type="text" id="numeroAssegno" placeholder="N° Assegno">
                            </div>
                        </div>

                        <label for="nomeCliente">Nome Cliente:</label><input type="text" id="nomeCliente" required>
                        <label for="numeroPolizza">Numero Polizza:</label><input type="text" id="numeroPolizza">
                        <label for="importo" id="label-importo">Importo Titolo (€):</label><input type="number" id="importo" step="0.01" placeholder="0.00" required oninput="calcolaImportoMultiplo()">
                        
                         <div id="divIncassoMultiplo" style="display:none;">
                            <hr>
                            <h4>Parte 1</h4>
                            <label>Importo Parte 1 (€):</label>
                            <input type="number" id="importoMultiplo1" step="0.01" oninput="calcolaImportoMultiplo()">
                            <label>Metodologia Parte 1:</label>
                            <select id="metodologiaMultiplo1" onchange="aggiornaCampiCondizionaliMultiplo(1)"></select>
                            <div id="campiCondizionaliMultiplo1"></div>
                            <hr>
                            <h4>Parte 2</h4>
                            <label>Importo Parte 2 (€):</label>
                            <input type="number" id="importoMultiplo2" step="0.01" readonly>
                            <label>Metodologia Parte 2:</label>
                            <select id="metodologiaMultiplo2" onchange="aggiornaCampiCondizionaliMultiplo(2)"></select>
                            <div id="campiCondizionaliMultiplo2"></div>
                            <hr>
                         </div>

                        <div id="divProvvigioni" style="display:none;">
                            <label for="provvigioni">Provvigioni (€):</label>
                            <input type="number" id="provvigioni" step="0.01" placeholder="0.00">
                        </div>
             
                        <label for="arrotondamenti">Arrotondamenti (€):</label><input type="number" id="arrotondamenti" step="0.01" placeholder="Es. -0.02">
                        
                        <label for="abbuoni">Abbuoni (€):</label>
                        <input type="number" id="abbuoni" step="0.01" placeholder="0.00" oninput="togglePersonaAbbuono()">
                        <div id="divPersonaAbbuono" style="display:none;">
                            <label for="personaAbbuono">Persona che effettua l'abbuono:</label>
                            <input type="text" id="personaAbbuono" placeholder="Nome persona">
                        </div>
                        
                        <label for="uscite">Uscite Cassa (€):</label><input type="number" id="uscite" step="0.01" placeholder="0.00">
                        <div id="form-buttons">
                            <button type="submit">Aggiungi Movimento</button>
                        </div>
                    </form>
                </div>
            </fieldset>
            <fieldset id="box-conteggio-cassa-fieldset">
                 <div class="box" id="box-conteggio-cassa">
                    <h2>3. Conteggio Fisico Cassa</h2>
                    <div id="conteggioBanconote"></div>
                    <div id="conteggioMonete"></div>
                    <div id="box-conteggio-assegni">
                        <h3>Assegni in Cassa</h3>
                        <div id="lista-conteggio-assegni"></div>
                        <button onclick="aggiungiCampoAssegnoConteggio()" class="button-secondary" style="width: auto; padding: 5px 10px; font-size: 0.9rem;">+ Aggiungi Assegno</button>
                    </div>
                    <div class="riepilogo-totali">Totale Contato Fisicamente: € <span id="totaleConteggioFisico">0.00</span></div>
                </div>
            </fieldset>
        </div>
    
        <div class="box">
            <h2>Riepilogo Movimenti di Cassa</h2>
            <table id="tabellaMovimenti">
                <thead><tr>
                    <th class="col-data-mensile">Data</th>
                    <th>Cliente</th><th>Polizza</th><th>Metodo</th><th>Importo (€)</th>
                    <th class="col-provvigioni">Provv.(€)</th>
                    <th>Arroton. (€)</th>
                    <th>Abbuoni (€)</th>
                    <th>Uscite (€)</th>
                    <th class="col-impatto-cassa">Impatto (€)</th>
                    <th>Azioni</th>
                 </tr></thead>
                <tbody></tbody>
            </table>
            <div class="riepilogo-totali col-cassa-teorica">Cassa Teorica Finale (Riporto + Movimenti): € <span id="cassaTeorica">0.00</span></div>
        </div>
        
        <div class="box" id="box-provvigioni" style="display:none;">
            <h2>Riepilogo Provvigioni e Decadi (Mese Corrente)</h2>
            <div class="riepilogo-totali">
                Totale Provvigioni del Mese: € <span id="provvigioni-mese-corrente">0.00</span>
            </div>
            <div class="decade-grid">
                <div><strong>1ª Decade (1-10):</strong> € <span id="decade1-result">0.00</span></div>
                <div><strong>2ª Decade (11-20):</strong> € <span id="decade2-result">0.00</span></div>
                <div><strong>3ª Decade (21+):</strong> € <span id="decade3-result">0.00</span></div>
            </div>
        </div>
        
        <div class="box" id="box-verifica-finale">
             <h2>4. Verifica Finale</h2>
            <button onclick="verificaChiusura()" class="button-secondary">VERIFICA I CONTI</button>
            <div class="risultato-verifica" id="risultatoVerifica">In attesa di verifica...</div>
        </div>
    </div>

    <div id="print-layout" style="display: none;">
        <div id="print-page-1">
            <h1 id="print-header"></h1>
            <div id="print-table-container"></div>
            <div id="print-cassa-teorica-container"></div>
        </div>
        <div id="print-page-2">
            <div id="print-conteggio-container"></div>
            <div id="print-verifica-container"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyD41OqDrIwwH7PrK_ywmYRYVrR_KAehiU8",
      authDomain: "giornalecassa.firebaseapp.com",
      projectId: "giornalecassa",
      storageBucket: "giornalecassa.appspot.com",
      messagingSenderId: "655250052165",
      appId: "1:655250052165:web:8cead9e63e7dd951773f2c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const dbRef = db.collection("gestione-cassa").doc("databaseCompleto");
    const statusIndicator = document.getElementById('status-indicator');
    let stato = { compagniaSelezionata: null, dataSelezionata: null, datiCompleti: {} };
    const tagliBanconote = [500, 200, 100, 50, 20, 10, 5];
    const tagliMonete = [2, 1, 0.50, 0.20, 0.10, 0.05, 0.02, 0.01];
    document.addEventListener('DOMContentLoaded', () => {
        caricaDatiDaFirebase();
    });
    async function caricaDatiDaFirebase() {
        if(statusIndicator) {
            statusIndicator.textContent = 'Caricamento...';
            statusIndicator.className = 'saving';
        }
        try {
            const doc = await dbRef.get();
            stato.datiCompleti = doc.exists ? doc.data() : {};
            if(statusIndicator) {
                statusIndicator.textContent = 'Pronto';
                statusIndicator.className = 'synced';
            }
        } catch (error) {
            console.error("Errore caricamento da Firebase: ", error);
            if(statusIndicator) {
                statusIndicator.textContent = 'Errore Connessione';
                statusIndicator.className = 'error';
            }
        }
    }

    async function salvaStatoCorrente(silenzioso = false, notificationId = null) {
        const indicator = notificationId ? document.getElementById(notificationId) : statusIndicator;
        if (!silenzioso && indicator && statusIndicator) {
            indicator.textContent = 'Salvataggio in corso...';
            indicator.className = 'save-notification success';
            indicator.style.display = 'block';
            indicator.style.opacity = '1';
        }

        try {
            if (stato.compagniaSelezionata && stato.dataSelezionata) salvaDatiLocali();

            if (stato.compagniaSelezionata) {
                const updateData = {};
                updateData[stato.compagniaSelezionata] = stato.datiCompleti[stato.compagniaSelezionata];
                await dbRef.update(updateData);
            } else {
                console.warn("Nessuna compagnia selezionata, salvataggio annullato.");
                 if (indicator) indicator.style.display = 'none';
                return;
            }

             if (indicator) {
                indicator.textContent = 'Salvato con successo!';
                indicator.className = 'save-notification success';
                if(!notificationId && statusIndicator) {
                    statusIndicator.className = 'synced';
                }
                indicator.style.opacity = '1';
                if(notificationId){
                    setTimeout(() => { 
                        indicator.style.opacity = '0';
                        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                    }, 2000);
                }
            }
        } catch (error) {
            console.error("Errore salvataggio su Firebase: ", error);
            if(indicator) {
                indicator.textContent = 'Errore Salvataggio';
                indicator.className = notificationId ? 'save-notification error' : 'error';
                indicator.style.opacity = '1';
                if(notificationId){
                    setTimeout(() => { 
                        indicator.style.opacity = '0';
                        setTimeout(() => { indicator.style.display = 'none'; }, 500);
                    }, 3000);
                }
            }
        }
    }
    
    async function inizializzaApp(compagnia) {
        stato.compagniaSelezionata = compagnia;
        document.body.className = `theme-${compagnia.toLowerCase()}`;
        document.getElementById('company-selector-modal').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        
        if (Object.keys(stato.datiCompleti).length === 0) {
           await caricaDatiDaFirebase();
        }
        
        document.getElementById('main-title').textContent = `Registro Cassa ${compagnia}`;
        const showProvvigioni = compagnia === 'HDI' || compagnia === 'Vittoria';
        document.getElementById('box-provvigioni').style.display = showProvvigioni ? 'block' : 'none';
        const selectMetodo = document.getElementById('metodologia');
        selectMetodo.innerHTML = `<option value="Contanti">Contanti</option><option value="Assegno">Assegno</option><option value="POS">POS</option><option value="Bonifico">Bonifico</option>`;
        
        selectMetodo.add(new Option('Versamento', 'Versamento'));
        
        if (compagnia === 'Allianz') {
             selectMetodo.add(new Option('Finanziamento Allianz Bank', 'Finanziamento Allianz Bank'));
        }
        if (['Allianz', 'HDI', 'Vittoria'].includes(compagnia)) {
            selectMetodo.add(new Option('Incasso Multiplo', 'Incasso Multiplo'));
        }

        selectMetodo.add(new Option('Anticipo', 'Anticipo'));
        selectMetodo.add(new Option('Rientro da Anticipo', 'Rientro da Anticipo'));
        const isSimplifiedView = compagnia === 'ARAG' || compagnia === 'Helvetia';
        document.getElementById('box-inizio-giornata').style.display = isSimplifiedView ? 'none' : 'block';
        document.getElementById('box-conteggio-cassa').style.display = isSimplifiedView ? 'none' : 'block';
        document.getElementById('box-verifica-finale').style.display = isSimplifiedView ? 'none' : 'block';
        
        document.getElementById('btn-festa').style.display = isSimplifiedView ? 'none' : 'inline-block';

        if (isSimplifiedView) {
            document.body.classList.add('vista-mensile');
            document.querySelector('#date-selector').labels[0].textContent = "Visualizza movimenti del mese:";
        } else {
            document.body.classList.remove('vista-mensile');
            document.querySelector('#date-selector').labels[0].textContent = "Giornale del:";
        }

        document.getElementById('date-selector').valueAsDate = new Date();
        caricaGiornale(new Date());
    }

    function toggleRiportoMode(isManual) {
        const inputRiporto = document.getElementById('riportoIniziale');
        const label = document.getElementById('riporto-mode-label');
        const dataKey = formatDate(stato.dataSelezionata);
        const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];
        if (isManual) {
            inputRiporto.readOnly = false;
            label.textContent = 'Riporto Manuale';
            datiGiorno.riportoIsManual = true;
        } else {
            inputRiporto.readOnly = true;
            label.textContent = 'Riporto Automatico';
            delete datiGiorno.riportoIsManual;
            inputRiporto.value = calcolaRiporto(stato.dataSelezionata).toFixed(2);
            aggiornaTuttiRiepiloghi();
        }
        salvaStatoCorrente(true);
    }

    function caricaGiornale(data) {
        if (!data) return;
        stato.dataSelezionata = data;
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';

        let movimentiDaMostrare = [];
        if (isSimplifiedView) {
            const selectedMonth = data.getMonth();
            const selectedYear = data.getFullYear();
            const datiCompagnia = stato.datiCompleti[stato.compagniaSelezionata] || {};
            for (const dKey in datiCompagnia) {
                const [year, month, day] = dKey.split('-').map(Number);
                const movDate = new Date(year, month - 1, day);
                
                if (movDate.getMonth() === selectedMonth && movDate.getFullYear() === selectedYear) {
                    const movimentiDelGiorno = datiCompagnia[dKey].movimenti || [];
                    movimentiDelGiorno.forEach(m => {
                        m.dataMovimento = dKey; 
                        movimentiDaMostrare.push(m);
                    });
                }
            }
            movimentiDaMostrare.sort((a, b) => new Date(b.dataMovimento) - new Date(a.dataMovimento));
        } else {
            const dataKey = formatDate(data);
            const datiCompagnia = stato.datiCompleti[stato.compagniaSelezionata] || {};
            let datiGiorno = datiCompagnia[dataKey];
            if (!datiGiorno) {
                datiGiorno = creaNuovoGiorno(data);
                if (!stato.datiCompleti[stato.compagniaSelezionata]) stato.datiCompleti[stato.compagniaSelezionata] = {};
                stato.datiCompleti[stato.compagniaSelezionata][dataKey] = datiGiorno;
            }

            const inputRiporto = document.getElementById('riportoIniziale');
            const toggle = document.getElementById('riporto-mode-toggle');
            const label = document.getElementById('riporto-mode-label');

            if (datiGiorno.riportoIsManual) {
                toggle.checked = true;
                label.textContent = 'Riporto Manuale';
                inputRiporto.readOnly = false;
                inputRiporto.value = (datiGiorno.riportoIniziale || 0).toFixed(2);
            } else {
                toggle.checked = false;
                label.textContent = 'Riporto Automatico';
                inputRiporto.readOnly = true;
                datiGiorno.riportoIniziale = calcolaRiporto(data);
                inputRiporto.value = datiGiorno.riportoIniziale.toFixed(2);
            }
            
            creaCampiConteggio(datiGiorno.conteggioFisico);
            const divRisultato = document.getElementById('risultatoVerifica');
            if (datiGiorno.verificaResult) {
                divRisultato.textContent = datiGiorno.verificaResult.text;
                divRisultato.className = datiGiorno.verificaResult.className;
            } else {
                divRisultato.textContent = 'In attesa di verifica...';
                divRisultato.className = 'risultato-verifica';
            }
            movimentiDaMostrare = (datiGiorno.movimenti || []).filter(m => !m.isManuallyAdded);
            impostaStatoGiornata(datiGiorno.isGiornoFestivo);
        }

        aggiornaTabellaMovimenti(movimentiDaMostrare);
        aggiornaTuttiRiepiloghi();
        annullaModifica();
    }
    
    function creaNuovoGiorno(data) {
        const riporto = calcolaRiporto(data);
        return { riportoIniziale: riporto, movimenti: [], conteggioFisico: {}, cassaTeorica: riporto };
    }

    function salvaDatiLocali() {
        if(!stato.compagniaSelezionata || !stato.dataSelezionata) return;
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        if (isSimplifiedView) return;

        const dataKey = formatDate(stato.dataSelezionata);
        if (!stato.datiCompleti[stato.compagniaSelezionata]) stato.datiCompleti[stato.compagniaSelezionata] = {};
        if (!stato.datiCompleti[stato.compagniaSelezionata][dataKey]) stato.datiCompleti[stato.compagniaSelezionata][dataKey] = creaNuovoGiorno(stato.dataSelezionata);
        
        const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];
        if (datiGiorno.riportoIsManual) {
            datiGiorno.riportoIniziale = parseFloat(document.getElementById('riportoIniziale').value) || 0;
        }
        
        datiGiorno.conteggioFisico = raccogliDatiConteggio();
    }

    function processaFormMovimento() {
        const dataPerSalvataggio = new Date(document.getElementById('date-selector').valueAsDate || new Date());
        const dataKey = formatDate(dataPerSalvataggio);

        if (!stato.datiCompleti[stato.compagniaSelezionata]) stato.datiCompleti[stato.compagniaSelezionata] = {};
        if (!stato.datiCompleti[stato.compagniaSelezionata][dataKey]) stato.datiCompleti[stato.compagniaSelezionata][dataKey] = creaNuovoGiorno(dataPerSalvataggio);
        const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];
        (datiGiorno.movimenti = datiGiorno.movimenti || []);
        
        const metodologia = document.getElementById('metodologia').value;
        const editingIndex = document.getElementById('editingIndex').value;

        if (metodologia === 'Versamento') {
            const versamentoContanti = parseFloat(document.getElementById('versamentoContanti').value) || 0;
            const versamentoAssegni = parseFloat(document.getElementById('versamentoAssegni').value) || 0;
            
            if (versamentoContanti > 0) {
                datiGiorno.movimenti.push({ metodologia: 'Versamento', nomeCliente: 'Versamento Contanti', uscite: versamentoContanti, importo: 0, numeroPolizza: '', provvigioni: 0, arrotondamenti: 0, abbuoni: 0, personaAbbuono: '' });
            }
            if (versamentoAssegni > 0) {
                datiGiorno.movimenti.push({ metodologia: 'Versamento', nomeCliente: 'Versamento Assegni', uscite: versamentoAssegni, importo: 0, numeroPolizza: '', provvigioni: 0, arrotondamenti: 0, abbuoni: 0, personaAbbuono: '' });
            }

        } else if (metodologia === 'Incasso Multiplo') {
            const commonData = { nomeCliente: document.getElementById('nomeCliente').value, numeroPolizza: document.getElementById('numeroPolizza').value, provvigioni: parseFloat(document.getElementById('provvigioni').value) || 0, arrotondamenti: parseFloat(document.getElementById('arrotondamenti').value) || 0, abbuoni: parseFloat(document.getElementById('abbuoni').value) || 0, personaAbbuono: document.getElementById('personaAbbuono').value, uscite: parseFloat(document.getElementById('uscite').value) || 0 };
            const importoTotale = parseFloat(document.getElementById('importo').value) || 0;
            const importo1 = parseFloat(document.getElementById('importoMultiplo1').value) || 0;
            const importo2 = parseFloat(document.getElementById('importoMultiplo2').value) || 0;
            if (Math.abs(importoTotale - (importo1 + importo2)) > 0.01) {
                alert("La somma delle due parti non corrisponde all'importo totale del titolo.");
                return;
            }
            const movimento1 = { ...commonData, isSplit: true, importo: importo1, metodologia: document.getElementById('metodologiaMultiplo1').value, ...leggiCampiCondizionaliMultiplo(1) };
            const movimento2 = { ...commonData, isSplit: true, importo: importo2, metodologia: document.getElementById('metodologiaMultiplo2').value, ...leggiCampiCondizionaliMultiplo(2) };
            datiGiorno.movimenti.push(movimento1, movimento2);
        } else {
             const movimento = {
                nomeCliente: document.getElementById('nomeCliente').value,
                numeroPolizza: document.getElementById('numeroPolizza').value,
                provvigioni: parseFloat(document.getElementById('provvigioni').value) || 0,
                arrotondamenti: parseFloat(document.getElementById('arrotondamenti').value) || 0,
                abbuoni: parseFloat(document.getElementById('abbuoni').value) || 0,
                personaAbbuono: document.getElementById('personaAbbuono').value,
                uscite: parseFloat(document.getElementById('uscite').value) || 0,
                importo: parseFloat(document.getElementById('importo').value) || 0,
                metodologia: metodologia,
                tipoPosAllianz: document.getElementById('tipoPosAllianz').value,
                tipoAnticipo: document.getElementById('tipoAnticipo').value,
                rientroMetodo: document.getElementById('rientroMetodo').value,
                numeroAssegno: document.getElementById('numeroAssegno').value,
            };
            if (editingIndex !== "") {
                const movimentiOriginali = datiGiorno.movimenti;
                const movimentiFiltrati = movimentiOriginali.filter(m => !m.isManuallyAdded);
                const movimentoDaModificare = movimentiFiltrati[editingIndex];
                const indiceOriginale = movimentiOriginali.indexOf(movimentoDaModificare);
                if (indiceOriginale > -1) {
                    datiGiorno.movimenti[indiceOriginale] = movimento;
                }
            } else {
                datiGiorno.movimenti.push(movimento);
            }
        }
        
        annullaModifica();
        caricaGiornale(dataPerSalvataggio);
        salvaStatoCorrente();
    }
    
    function modificaMovimento(index, dataMovimento) {
        const dataKey = dataMovimento || formatDate(stato.dataSelezionata);
        const movimentiDelGiorno = (stato.datiCompleti[stato.compagniaSelezionata][dataKey].movimenti || []).filter(m => !m.isManuallyAdded);
        const movimento = movimentiDelGiorno[index];
        
        document.getElementById('editingIndex').value = index;
        document.getElementById('metodologia').value = movimento.metodologia;

        // La modalità versamento non è modificabile, quindi non serve gestirla qui.
        document.getElementById('tipoPosAllianz').value = movimento.tipoPosAllianz || 'POS Direzione';
        document.getElementById('tipoAnticipo').value = movimento.tipoAnticipo || 'Anticipo Contanti';
        document.getElementById('rientroMetodo').value = movimento.rientroMetodo || 'Contanti';
        document.getElementById('numeroAssegno').value = movimento.numeroAssegno;
        document.getElementById('nomeCliente').value = movimento.nomeCliente;
        document.getElementById('numeroPolizza').value = movimento.numeroPolizza;
        document.getElementById('importo').value = movimento.importo;
        document.getElementById('provvigioni').value = movimento.provvigioni || '';
        document.getElementById('arrotondamenti').value = movimento.arrotondamenti;
        document.getElementById('abbuoni').value = movimento.abbuoni || '';
        document.getElementById('personaAbbuono').value = movimento.personaAbbuono || '';
        document.getElementById('uscite').value = movimento.uscite;
        
        document.getElementById('date-selector').value = dataKey;
        
        const [year, month, day] = dataKey.split('-').map(Number);
        const dateToSet = new Date(year, month - 1, day);
        document.getElementById('form-title').textContent = `Modifica Movimento del ${dateToSet.toLocaleDateString('it-IT')}`;
        document.getElementById('form-buttons').innerHTML = `<button type="submit">Salva Modifiche</button><button type="button" class="button-secondary" onclick="annullaModifica()">Annulla</button>`;
        aggiornaCampiCondizionali();
        togglePersonaAbbuono();
        window.scrollTo(0, 0);
    }

    function annullaModifica() {
        document.getElementById('editingIndex').value = "";
        document.getElementById('formMovimento').reset();
        document.getElementById('form-title').textContent = "2. Registrazione Movimento";
        document.getElementById('form-buttons').innerHTML = `<button type="submit">Aggiungi Movimento</button>`;
        aggiornaCampiCondizionali();
        togglePersonaAbbuono();
    }

    function cancellaMovimento(index, dataMovimento) {
        if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
            const dataKey = dataMovimento || formatDate(stato.dataSelezionata);
            const movimentiOriginali = stato.datiCompleti[stato.compagniaSelezionata][dataKey].movimenti;
            const movimentiFiltrati = movimentiOriginali.filter(m => !m.isManuallyAdded);
            const movimentoDaCancellare = movimentiFiltrati[index];
            const indiceOriginale = movimentiOriginali.indexOf(movimentoDaCancellare);
            if (indiceOriginale > -1) {
                movimentiOriginali.splice(indiceOriginale, 1);
                caricaGiornale(stato.dataSelezionata);
                salvaStatoCorrente();
            }
        }
    }

    function rendiProvvigioneEditabile(cell, index, dataMovimento) {
        if (cell.querySelector('input')) return;
        const dataKey = dataMovimento || formatDate(stato.dataSelezionata);
        const valoreCorrente = cell.textContent;
        cell.innerHTML = `<input type="number" step="0.01" value="${valoreCorrente}" style="width: 80px; padding: 2px;" onblur="salvaProvvigioneModificata(this, ${index}, '${dataKey}')" onkeydown="if(event.key === 'Enter') this.blur()"/>`;
        const input = cell.querySelector('input');
        input.focus();
    }

    function salvaProvvigioneModificata(input, index, dataKey) {
        const nuovoValore = parseFloat(input.value) || 0;
        const movimentiDelGiorno = (stato.datiCompleti[stato.compagniaSelezionata][dataKey].movimenti || []).filter(m => !m.isManuallyAdded);
        movimentiDelGiorno[index].provvigioni = nuovoValore;
        caricaGiornale(stato.dataSelezionata);
        salvaStatoCorrente();
    }

    function creaCampiConteggio(datiConteggio = {}) {
        const divBanconote = document.getElementById('conteggioBanconote');
        const divMonete = document.getElementById('conteggioMonete');
        divBanconote.innerHTML = '<h3>Banconote</h3>';
        divMonete.innerHTML = '<h3>Monete</h3>';
        [...tagliBanconote, ...tagliMonete].forEach(taglio => {
            const tipo = taglio >= 5 ? 'banconote' : 'monete';
            const div = tipo === 'banconote' ? divBanconote : divMonete;
            const valoreSalvato = datiConteggio?.[tipo]?.[taglio] || '';
            const idTaglio = taglio.toString().replace('.', '_');
            div.innerHTML += `
                <div class="conteggio-grid" style="display: grid; grid-template-columns: 1fr 2fr 2fr; align-items: center; gap: 5px; margin-bottom: 5px;">
                    <label style="font-weight: bold;">€ ${taglio.toFixed(2)}</label>
                    <input type="number" oninput="salvaDatiLocali(); calcolaConteggioFisico();" data-valore="${taglio}" data-tipo="${tipo}" value="${valoreSalvato}" placeholder="N° pezzi">
                    <span id="subtotale-${idTaglio}">€ 0.00</span>
                </div>`;
        });
        const divAssegni = document.getElementById('lista-conteggio-assegni');
        divAssegni.innerHTML = '';
        const assegniSalvati = datiConteggio?.assegni || [];
        assegniSalvati.forEach((importo) => {
            aggiungiCampoAssegnoConteggio(importo);
        });
        calcolaConteggioFisico();
    }

    function aggiungiCampoAssegnoConteggio(importo = '') {
        const divAssegni = document.getElementById('lista-conteggio-assegni');
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
        div.innerHTML = `
            <input type="number" step="0.01" class="conteggio-assegno" placeholder="Importo Assegno" value="${importo}" oninput="salvaDatiLocali(); calcolaConteggioFisico();">
            <button type="button" class="button-delete" style="width:auto;" onclick="this.parentElement.remove(); salvaDatiLocali(); calcolaConteggioFisico();">X</button>
        `;
        divAssegni.appendChild(div);
    }

    function raccogliDatiConteggio() {
        const conteggio = { banconote: {}, monete: {}, assegni: [] };
        document.querySelectorAll('#conteggioBanconote input, #conteggioMonete input').forEach(input => {
            if (input.value && parseInt(input.value) > 0) {
                conteggio[input.dataset.tipo][input.dataset.valore] = parseInt(input.value, 10);
            }
        });
        document.querySelectorAll('.conteggio-assegno').forEach(input => {
            const valore = parseFloat(input.value);
            if (!isNaN(valore) && valore > 0) {
                conteggio.assegni.push(valore);
            }
        });
        return conteggio;
    }
    
    function aggiornaTabellaMovimenti(movimenti = []) {
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        const tbody = document.getElementById('tabellaMovimenti').querySelector('tbody');
        tbody.innerHTML = '';
        const showProvvigioni = stato.compagniaSelezionata === 'HDI' || stato.compagniaSelezionata === 'Vittoria';
        (movimenti || []).forEach((m, index) => {
            const dataKeyOriginale = m.dataMovimento || formatDate(stato.dataSelezionata);
            
            const isCashBased = (m.metodologia === 'Contanti' || m.metodologia === 'Assegno') ||
                                (m.metodologia === 'Rientro da Anticipo' && (m.rientroMetodo === 'Contanti' || m.rientroMetodo === 'Assegno'));

            let impattoCassa = 0;
            if (isCashBased) {
                impattoCassa = (m.importo || 0) + (m.arrotondamenti || 0) - (m.abbuoni || 0);
            }
            impattoCassa -= (m.uscite || 0);

            let metodoDisplay = m.metodologia;
    
            if (m.metodologia === 'Anticipo') {
                metodoDisplay = `Anticipo (${m.tipoAnticipo || ''})`;
            } else if (m.metodologia === 'POS' && stato.compagniaSelezionata === 'Allianz') {
                metodoDisplay = `POS (${m.tipoPosAllianz || ''})`;
            } else if (m.metodologia === 'Assegno') {
                metodoDisplay += ` ${m.numeroAssegno || ''}`;
            } else if (m.metodologia === 'Rientro da Anticipo') {
                metodoDisplay += ` (${m.rientroMetodo || ''})`;
                if (m.rientroMetodo === 'Assegno') {
                     metodoDisplay += ` ${m.numeroAssegno || ''}`;
                }
            }
            
            const riga = tbody.insertRow();
            const [year, month, day] = dataKeyOriginale.split('-').map(Number);
            const dataLocale = new Date(year, month-1, day);
            riga.innerHTML = `
                <td class="col-data-mensile">${dataLocale.toLocaleDateString('it-IT')}</td>
                <td>${m.nomeCliente || ''}</td>
                <td>${m.numeroPolizza || ''}</td>
                <td>${metodoDisplay || ''}</td>
                <td>${(m.importo || 0).toFixed(2)}</td>
                <td class="col-provvigioni provvigione-editabile" onclick="rendiProvvigioneEditabile(this, ${index}, '${dataKeyOriginale}')">${(m.provvigioni || 0).toFixed(2)}</td>
                <td>${(m.arrotondamenti || 0).toFixed(2)}</td>
                <td>${(m.abbuoni || 0).toFixed(2)}</td>
                <td>${(m.uscite || 0).toFixed(2)}</td>
                <td class="col-impatto-cassa"><strong>${impattoCassa.toFixed(2)}</strong></td>
                <td>
                    <button type="button" class="button-edit" onclick="modificaMovimento(${index}, '${dataKeyOriginale}')" ${m.isSplit || m.metodologia === 'Versamento' ? 'disabled title="Questo tipo di movimento non è modificabile"' : ''}>Modifica</button>
                    <button type="button" class="button-delete" onclick="cancellaMovimento(${index}, '${dataKeyOriginale}')">Elimina</button>
                </td>`;
        });
        document.querySelectorAll('.col-provvigioni').forEach(el => el.style.display = showProvvigioni ? '' : 'none');
    }
    
    function aggiornaTuttiRiepiloghi() {
        if (!stato.compagniaSelezionata) return;
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        if (!isSimplifiedView) {
            calcolaCassaTeorica();
            calcolaConteggioFisico();
        }
        if (stato.compagniaSelezionata === 'HDI' || stato.compagniaSelezionata === 'Vittoria') {
            aggiornaRiepilogoProvvigioni();
        }
    }
    
    function calcolaConteggioFisico() {
        let totale = 0;
        document.querySelectorAll('#conteggioBanconote input, #conteggioMonete input').forEach(input => {
            const valore = parseFloat(input.dataset.valore);
            const quantita = parseInt(input.value) || 0;
            const subtotale = valore * quantita;
            totale += subtotale;
            document.getElementById(`subtotale-${valore.toString().replace('.', '_')}`).textContent = `€ ${subtotale.toFixed(2)}`;
        });
        document.querySelectorAll('.conteggio-assegno').forEach(input => {
            totale += parseFloat(input.value) || 0;
        });
        document.getElementById('totaleConteggioFisico').textContent = totale.toFixed(2);
        return totale;
    }
    
    function calcolaRiporto(data) {
        const giornoPrecedenteLavorativo = getGiornoPrecedenteLavorativo(data);
        const dataKeyPrec = formatDate(giornoPrecedenteLavorativo);
        const datiCompagnia = stato.datiCompleti[stato.compagniaSelezionata] || {};
        const datiGiornoPrec = datiCompagnia[dataKeyPrec];
        if (datiGiornoPrec) {
            return datiGiornoPrec.cassaTeorica || 0;
        }
        return 0;
    }
    
    function verificaChiusura() {
        const teorica = calcolaCassaTeorica();
        const fisica = calcolaConteggioFisico();
        const differenza = teorica - fisica;
        const divRisultato = document.getElementById('risultatoVerifica');
        const dataKey = formatDate(stato.dataSelezionata);
        const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];

        if (Math.abs(differenza) < 0.01) {
            divRisultato.textContent = `✅ I CONTI TORNANO! Differenza: € 0.00`;
            divRisultato.className = 'risultato-verifica ok';
        } else {
            divRisultato.textContent = `❌ ATTENZIONE! Differenza di cassa: € ${differenza.toFixed(2)}`;
            divRisultato.className = 'risultato-verifica errore';
        }
        if (datiGiorno) {
            datiGiorno.verificaResult = { text: divRisultato.textContent, className: divRisultato.className };
        }
    }

    function calcolaCassaTeorica() {
        const riporto = parseFloat(document.getElementById('riportoIniziale').value) || 0;
        if(!stato.dataSelezionata || !stato.compagniaSelezionata) return riporto;
        
        const dataKey = formatDate(stato.dataSelezionata);
        const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata]?.[dataKey];
        if (!datiGiorno) return riporto;
        const movimenti = (datiGiorno.movimenti || []).filter(m => !m.isManuallyAdded);
        const totaleMovimentiCassa = movimenti.reduce((acc, m) => {
            const isCashBased = (m.metodologia === 'Contanti' || m.metodologia === 'Assegno') ||
                                (m.metodologia === 'Rientro da Anticipo' && (m.rientroMetodo === 'Contanti' || m.rientroMetodo === 'Assegno'));

            let impatto = 0;
            if (isCashBased) {
                impatto = (m.importo || 0) + (m.arrotondamenti || 0) - (m.abbuoni || 0);
            }
            impatto -= (m.uscite || 0);

            return acc + impatto;
        }, 0);
        const cassaTeorica = riporto + totaleMovimentiCassa;
        
        datiGiorno.cassaTeorica = cassaTeorica;

        document.getElementById('cassaTeorica').textContent = cassaTeorica.toFixed(2);
        return cassaTeorica;
    }
        
    function aggiornaCampiCondizionali() {
        if (!stato.compagniaSelezionata) return;
        const metodologia = document.getElementById('metodologia').value;
        const isVersamento = metodologia === 'Versamento';

        const fields = ['nomeCliente', 'numeroPolizza', 'importo', 'arrotondamenti', 'abbuoni', 'uscite'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            const label = document.querySelector(`label[for="${id}"]`);
            const display = isVersamento ? 'none' : 'block';
            if (el) el.style.display = display;
            if (label) label.style.display = display;
        });

        document.getElementById('divVersamento').style.display = isVersamento ? 'block' : 'none';
        document.getElementById('nomeCliente').required = !isVersamento;
        document.getElementById('importo').required = !isVersamento;

        if (isVersamento) {
            document.getElementById('divIncassoMultiplo').style.display = 'none';
            document.getElementById('divTipoPosAllianz').style.display = 'none';
            document.getElementById('divTipoAnticipo').style.display = 'none';
            document.getElementById('divRientroMetodo').style.display = 'none';
            document.getElementById('divNumeroAssegno').style.display = 'none';
            document.getElementById('divProvvigioni').style.display = 'none';
            document.getElementById('divPersonaAbbuono').style.display = 'none';
        } else {
            const isMultiplo = metodologia === 'Incasso Multiplo';
            document.getElementById('divIncassoMultiplo').style.display = isMultiplo ? 'block' : 'none';
            document.getElementById('campi-standard').style.display = isMultiplo ? 'none' : 'block';
            
            if (isMultiplo) {
                const opzioniBase = Array.from(document.getElementById('metodologia').options)
                                        .filter(opt => !['Incasso Multiplo', 'Versamento'].includes(opt.value))
                                        .map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
                document.getElementById('metodologiaMultiplo1').innerHTML = opzioniBase;
                document.getElementById('metodologiaMultiplo2').innerHTML = opzioniBase;
                aggiornaCampiCondizionaliMultiplo(1);
                aggiornaCampiCondizionaliMultiplo(2);
                calcolaImportoMultiplo();
                return;
            }

            const compagnia = stato.compagniaSelezionata;
            const rientroMetodo = document.getElementById('rientroMetodo').value;
            const tipoAnticipo = document.getElementById('tipoAnticipo').value;
            const showProvvigioni = (compagnia === 'HDI' || compagnia === 'Vittoria') && metodologia !== 'Rientro da Anticipo';
            const showRientro = metodologia === 'Rientro da Anticipo';
            const showAssegno = metodologia === 'Assegno' || (showRientro && rientroMetodo === 'Assegno') || (metodologia === 'Anticipo' && tipoAnticipo === 'Anticipo Assegno');
            const showTipoAnticipo = metodologia === 'Anticipo';
            const showTipoPosAllianz = metodologia === 'POS' && compagnia === 'Allianz';
            
            document.getElementById('divProvvigioni').style.display = showProvvigioni ? 'block' : 'none';
            document.getElementById('divRientroMetodo').style.display = showRientro ? 'block' : 'none';
            document.getElementById('divNumeroAssegno').style.display = showAssegno ? 'block' : 'none';
            document.getElementById('divTipoAnticipo').style.display = showTipoAnticipo ? 'block' : 'none';
            document.getElementById('divTipoPosAllianz').style.display = showTipoPosAllianz ? 'block' : 'none';
            
            if (!showProvvigioni) document.getElementById('provvigioni').value = '';
            if (!showAssegno) document.getElementById('numeroAssegno').value = '';
        }
    }

    function aggiornaRiepilogoProvvigioni() {
        if (!stato.dataSelezionata) return;
        const datiCompagnia = stato.datiCompleti[stato.compagniaSelezionata] || {};
        const meseCorrente = stato.dataSelezionata.getMonth();
        const annoCorrente = stato.dataSelezionata.getFullYear();

        let totaleProvvigioniMese = 0;
        const decadi = { 1: { titoli: 0, provvigioni: 0 }, 2: { titoli: 0, provvigioni: 0 }, 3: { titoli: 0, provvigioni: 0 } };
        for (const dataKey in datiCompagnia) {
            const [year, month, day] = dataKey.split('-').map(Number);
            const dataGiornale = new Date(year, month - 1, day);
            
            if (dataGiornale.getMonth() === meseCorrente && dataGiornale.getFullYear() === annoCorrente) {
                (datiCompagnia[dataKey].movimenti || []).forEach(m => {
                    const giorno = dataGiornale.getDate();
                    totaleProvvigioniMese += (m.provvigioni || 0);
                
                     if (m.metodologia !== 'Rientro da Anticipo') {
                        const decadeNum = giorno <= 10 ? 1 : (giorno <= 20 ? 2 : 3);
                        decadi[decadeNum].titoli += m.importo;
                        decadi[decadeNum].provvigioni += (m.provvigioni || 0);
                    }
                });
            }
        }

        document.getElementById('provvigioni-mese-corrente').textContent = totaleProvvigioniMese.toFixed(2);
        document.getElementById('decade1-result').textContent = (decadi[1].titoli - decadi[1].provvigioni).toFixed(2);
        document.getElementById('decade2-result').textContent = (decadi[2].titoli - decadi[2].provvigioni).toFixed(2);
        document.getElementById('decade3-result').textContent = (decadi[3].titoli - decadi[3].provvigioni).toFixed(2);
    }
    
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getGiornoPrecedenteLavorativo(data) {
        let dataPrec = new Date(data);
        dataPrec.setDate(data.getDate() - 1);
        while (dataPrec.getDay() === 0 || dataPrec.getDay() === 6) {
            dataPrec.setDate(dataPrec.getDate() - 1);
        }
        return dataPrec;
    }
    
    function togglePersonaAbbuono() {
        const abbuoniVal = parseFloat(document.getElementById('abbuoni').value) || 0;
        const div = document.getElementById('divPersonaAbbuono');
        div.style.display = abbuoniVal > 0 ? 'block' : 'none';
        if (abbuoniVal <= 0) {
            document.getElementById('personaAbbuono').value = '';
        }
    }

    // ===============================================
    // FUNZIONI DI BACKUP, STAMPA E FESTIVITA'
    // ===============================================
    
    function esportaBackup() {
        if (Object.keys(stato.datiCompleti).length === 0) {
            alert("Nessun dato da esportare. Prova a caricare prima una compagnia.");
            return;
        }
        try {
            const datiJson = JSON.stringify(stato.datiCompleti, null, 2);
            const blob = new Blob([datiJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_cassa_${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Backup esportato con successo!");
        } catch (error) {
            console.error("Errore durante l'esportazione del backup:", error);
            alert("Si è verificato un errore durante l'esportazione.");
        }
    }

    function importaBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const datiImportati = JSON.parse(event.target.result);
                    if (typeof datiImportati === 'object' && datiImportati !== null && !Array.isArray(datiImportati)) {
                        if (confirm("Sei sicuro di voler importare questo backup? I dati attuali verranno sovrascritti.")) {
                            stato.datiCompleti = datiImportati;
                            await dbRef.set(stato.datiCompleti);
                            alert("Backup importato e salvato online con successo! La pagina verrà ricaricata.");
                            location.reload();
                        }
                    } else {
                        throw new Error("Formato file non valido.");
                    }
                } catch (error) {
                    console.error("Errore durante l'importazione del backup:", error);
                    alert("Impossibile importare il backup. Il file potrebbe essere corrotto o non avere il formato corretto.");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function stampaPersonalizzata() {
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        const printLayout = document.getElementById('print-layout');
        printLayout.classList.toggle('simplified-print', isSimplifiedView);

        const compagnia = stato.compagniaSelezionata;
        const data = document.getElementById('date-selector').valueAsDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('print-header').textContent = `Giornale Cassa del ${data} - Compagnia: ${compagnia}`;

        const tableOrig = document.getElementById('tabellaMovimenti');
        const tableContainerPrint = document.getElementById('print-table-container');
        tableContainerPrint.innerHTML = '';
        tableContainerPrint.appendChild(tableOrig.cloneNode(true));
        
        const cassaTeoricaOrig = document.querySelector('.col-cassa-teorica');
        const cassaTeoricaContainerPrint = document.getElementById('print-cassa-teorica-container');
        cassaTeoricaContainerPrint.innerHTML = '';
        if (cassaTeoricaOrig) cassaTeoricaContainerPrint.appendChild(cassaTeoricaOrig.cloneNode(true));

        const conteggioOrig = document.getElementById('box-conteggio-cassa');
        const conteggioContainerPrint = document.getElementById('print-conteggio-container');
        conteggioContainerPrint.innerHTML = '';
        const conteggioClonato = conteggioOrig.cloneNode(true)
        const addCheckButton = conteggioClonato.querySelector('button');
        if(addCheckButton) addCheckButton.remove();
        conteggioContainerPrint.appendChild(conteggioClonato);

        const verificaOrig = document.getElementById('risultatoVerifica');
        const verificaContainerPrint = document.getElementById('print-verifica-container');
        verificaContainerPrint.innerHTML = '';
        verificaContainerPrint.appendChild(verificaOrig.cloneNode(true));
        
        window.print();
    }

    function impostaStatoGiornata(isFestivo) {
        document.getElementById('form-movimento-fieldset').disabled = !!isFestivo;
        document.getElementById('box-conteggio-cassa-fieldset').disabled = !!isFestivo;
        const btn = document.getElementById('btn-festa');
        if (isFestivo) {
            btn.textContent = 'Riattiva Giorno';
            btn.onclick = annullaChiusuraFestiva;
            btn.style.backgroundColor = '#28a745';
        } else {
            btn.textContent = 'Festa/Chiusura';
            btn.onclick = gestisciChiusuraFestiva;
            btn.style.backgroundColor = '#6c757d';
        }
    }

    async function gestisciChiusuraFestiva() {
        if (confirm("Sei sicuro di voler impostare questo giorno come festivo? Non sarà più possibile inserire movimenti e il saldo verrà riportato al giorno successivo.")) {
            const dataKey = formatDate(stato.dataSelezionata);
            const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];
            datiGiorno.isGiornoFestivo = true;
            datiGiorno.cassaTeorica = datiGiorno.riportoIniziale;
            await salvaStatoCorrente(true);
            caricaGiornale(stato.dataSelezionata);
        }
    }
    
    async function annullaChiusuraFestiva() {
        if (confirm("Vuoi riattivare questo giorno per l'inserimento?")) {
            const dataKey = formatDate(stato.dataSelezionata);
            const datiGiorno = stato.datiCompleti[stato.compagniaSelezionata][dataKey];
            delete datiGiorno.isGiornoFestivo;
            await salvaStatoCorrente(true);
            caricaGiornale(stato.dataSelezionata);
        }
    }


    // ===============================================
    // SISTEMA DI GESTIONE TABELLE GENERICHE
    // ===============================================
    
    let datiTabellaCorrente = [];
    let configTabellaCorrente = {};

    const configsTabelle = {
        'anticipi': {
            type: 'anticipi',
            title: 'Gestione Anticipi',
            columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', tipoAnticipo: 'Tipo Anticipo', anticipoDi: 'Anticipo di', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' },
            filterFn: mov => mov.metodologia === 'Anticipo'
        },
        'bonifici_allianz': {
            type: 'bonifici_allianz',
            title: 'Gestione Bonifici (Allianz)',
            columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' },
            filterFn: mov => mov.metodologia === 'Bonifico' && mov.compagnia === 'Allianz'
        },
        'bonifici_hdi_arag': {
            type: 'bonifici_hdi_arag',
            title: 'Gestione Bonifici (HDI/ARAG)',
            columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' },
            filterFn: mov => mov.metodologia === 'Bonifico' && (mov.compagnia === 'HDI' || mov.compagnia === 'ARAG')
        },
        'pos_hdi_arag': {
            type: 'pos_hdi_arag',
            title: 'Gestione POS (HDI/ARAG)',
            columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' },
            filterFn: mov => mov.metodologia === 'POS' && (mov.compagnia === 'HDI' || mov.compagnia === 'ARAG')
        },
        'abbuoni': {
            type: 'abbuoni',
            title: 'Gestione Abbuoni',
            columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', abbuoni: 'Importo Abbuono (€)', personaAbbuono: 'Effettuato da', note: 'Note', abbuonoRegolato: 'Regolato' },
            filterFn: mov => mov.abbuoni && parseFloat(mov.abbuoni) > 0,
            hasTextFilter: true, 
            textFilterKey: 'personaAbbuono'
        }
    };
    
    async function mostraTabella(tipo) {
        configTabellaCorrente = configsTabelle[tipo];
        if (!configTabellaCorrente) return;
        if (Object.keys(stato.datiCompleti).length === 0) await caricaDatiDaFirebase();

        datiTabellaCorrente = [];
        for (const compagnia in stato.datiCompleti) {
            for (const dataKey in stato.datiCompleti[compagnia]) {
                (stato.datiCompleti[compagnia][dataKey].movimenti || []).forEach((mov, index) => {
                    const movimentoCompleto = { ...mov, compagnia, dataKey, originalIndex: index };
                    if (configTabellaCorrente.filterFn(movimentoCompleto)) {
                        datiTabellaCorrente.push(movimentoCompleto);
                    }
                });
            }
        }
        
        document.getElementById('generic-modal-title').textContent = configTabellaCorrente.title;
        popolaFiltri(datiTabellaCorrente);
        applicaFiltriTabella();

        const textFilter = document.getElementById('generic-filtro-testo');
        if (configTabellaCorrente.hasTextFilter) {
            textFilter.style.display = 'inline-block';
            const placeholderText = configTabellaCorrente.columns[configTabellaCorrente.textFilterKey] || 'persona';
            textFilter.placeholder = `Cerca per ${placeholderText}...`;
        } else {
            textFilter.style.display = 'none';
        }

        document.getElementById('generic-modal').style.display = 'flex';
    }

    function popolaFiltri(dati) {
        const annoSelect = document.getElementById('generic-filtro-anno');
        const meseSelect = document.getElementById('generic-filtro-mese');
        
        const years = new Set(dati.map(d => {
            const [year] = d.dataKey.split('-');
            return parseInt(year);
        }));
        years.add(new Date().getFullYear());
        const sortedYears = Array.from(years).sort((a, b) => b - a);
        
        annoSelect.innerHTML = '<option value="tutti">Tutti</option>';
        sortedYears.forEach(y => annoSelect.innerHTML += `<option value="${y}">${y}</option>`);

        meseSelect.innerHTML = '<option value="tutti">Tutti</option>';
        const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
        mesi.forEach((mese, index) => meseSelect.innerHTML += `<option value="${index}">${mese}</option>`);
        
        resetFiltriTabella();
    }
    
    function applicaFiltriTabella() {
        const anno = document.getElementById('generic-filtro-anno').value;
        const mese = document.getElementById('generic-filtro-mese').value;
        const giorno = document.getElementById('generic-filtro-giorno').value;
        const testo = document.getElementById('generic-filtro-testo').value.toLowerCase();
        
        let datiFiltrati = datiTabellaCorrente;
        if (giorno) {
            datiFiltrati = datiFiltrati.filter(d => d.dataKey === giorno);
        } else {
            if (anno !== 'tutti') {
                datiFiltrati = datiFiltrati.filter(d => d.dataKey.startsWith(anno));
            }
            if (mese !== 'tutti') {
                datiFiltrati = datiFiltrati.filter(d => {
                    const [, month] = d.dataKey.split('-');
                    return parseInt(month) - 1 == mese;
                });
            }
        }

        if (testo && configTabellaCorrente.hasTextFilter) {
            const filterKey = configTabellaCorrente.textFilterKey;
            datiFiltrati = datiFiltrati.filter(d =>
                d[filterKey] && d[filterKey].toLowerCase().includes(testo)
            );
        }

        popolaTabellaGenerica(datiFiltrati);
    }

    function resetFiltriTabella() {
        document.getElementById('generic-filtro-anno').value = 'tutti';
        document.getElementById('generic-filtro-mese').value = 'tutti';
        document.getElementById('generic-filtro-giorno').value = '';
        document.getElementById('generic-filtro-testo').value = '';
        applicaFiltriTabella();
    }

    function popolaTabellaGenerica(dati) {
        const table = document.getElementById('generic-table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        const headerRow = thead.insertRow();
        for (const key in configTabellaCorrente.columns) {
            const th = document.createElement('th');
            th.textContent = configTabellaCorrente.columns[key];
            if (th.textContent === 'Note') th.classList.add('col-note');
            headerRow.appendChild(th);
        }
        const thAzioni = document.createElement('th');
        thAzioni.textContent = 'Azioni';
        headerRow.appendChild(thAzioni);

        dati.sort((a, b) => new Date(b.dataKey) - new Date(a.dataKey));
        dati.forEach(d => {
            const isLocked = !d.isManuallyAdded;
            const riga = tbody.insertRow();
            riga.dataset.compagnia = d.compagnia;
            riga.dataset.key = d.dataKey;
            riga.dataset.index = d.originalIndex;
            
            for (const key in configTabellaCorrente.columns) {
                const cell = riga.insertCell();
                cell.dataset.property = key;
                let content = d[key] || '';

                switch(key) {
                    case 'dataKey':
                        const [year, month, day] = content.split('-').map(Number);
                        cell.textContent = new Date(year, month-1, day).toLocaleDateString('it-IT');
                        break;
                    case 'importo':
                    case 'abbuoni':
                        cell.textContent = (content || 0).toFixed(2);
                        if (!isLocked && key === 'importo') {
                           cell.contentEditable = true;
                           cell.onblur = (e) => salvaModificaGenerica(e.target);
                        }
                        break;
                    case 'nomeCliente':
                    case 'numeroPolizza':
                        cell.textContent = content;
                        if (!isLocked) {
                           cell.contentEditable = true;
                           cell.onblur = (e) => salvaModificaGenerica(e.target);
                        }
                        break;
                    case 'note':
                        cell.textContent = content;
                        cell.contentEditable = true;
                        cell.onblur = (e) => salvaModificaGenerica(e.target);
                        cell.classList.add('col-note');
                        break;
                    case 'anticipoDi':
                        cell.innerHTML = `<input type="text" value="${content}" onchange="salvaModificaGenerica(this)">`;
                        break;
                    case 'dataEstinzione':
                        cell.innerHTML = `<input type="date" value="${content}" onchange="salvaModificaGenerica(this)">`;
                        break;
                    case 'incassato':
                    case 'abbuonoRegolato':
                        cell.innerHTML = `<input type="checkbox" ${content ? 'checked' : ''} onchange="salvaModificaGenerica(this)">`;
                        break;
                    default:
                        cell.textContent = content;
                }
            }
            
            const cellaAzioni = riga.insertCell();
            cellaAzioni.style.textAlign = 'center';
            if (isLocked) {
                cellaAzioni.innerHTML = `<i class="fa fa-lock" title="Modificabile/Eliminabile solo dal giornale di cassa di riferimento"></i>`;
            } else {
                cellaAzioni.innerHTML = `<button class="button-delete" onclick="cancellaMovimentoGenerico(this)">Elimina</button>`;
            }
            
            aggiornaStileRiga(riga);
        });
    }

    async function cancellaMovimentoGenerico(buttonEl) {
        const riga = buttonEl.closest('tr');
        const { compagnia, key, index } = riga.dataset;

        if (confirm('Sei sicuro di voler eliminare definitivamente questo movimento?')) {
            const movimenti = stato.datiCompleti[compagnia]?.[key]?.movimenti;
            if (movimenti && movimenti[index] !== undefined) {
                movimenti.splice(index, 1);
                await salvaTutteLeModificheTabella();
                alert('Movimento eliminato.');
                mostraTabella(configTabellaCorrente.type); 
            } else {
                alert('Errore: movimento non trovato. Potrebbe essere già stato eliminato.');
                mostraTabella(configTabellaCorrente.type);
            }
        }
    }
    
    function salvaModificaGenerica(el) {
        const cell = el.closest('td');
        const riga = cell.closest('tr');
        const proprieta = cell.dataset.property;
        const { compagnia, key, index } = riga.dataset;
        if (stato.datiCompleti[compagnia]?.[key]?.movimenti?.[index]) {
            let valore;
            if (el.isContentEditable) {
                 valore = (proprieta === 'importo' || proprieta === 'abbuoni') ? parseFloat(el.textContent.replace(',', '.')) || 0 : el.textContent;
            } else {
                valore = el.type === 'checkbox' ? el.checked : el.value;
            }
            
            stato.datiCompleti[compagnia][key].movimenti[index][proprieta] = valore;
            aggiornaStileRiga(riga);
        }
    }
    
    async function salvaTutteLeModificheTabella() {
        const indicator = document.getElementById('generic-modal-notification');
        indicator.textContent = 'Salvataggio in corso...';
        indicator.className = 'save-notification success';
        indicator.style.display = 'block';
        indicator.style.opacity = '1';

        try {
            await dbRef.set(stato.datiCompleti);
            
            indicator.textContent = 'Salvato con successo!';
            indicator.className = 'save-notification success';
            setTimeout(() => { 
                indicator.style.opacity = '0';
                setTimeout(() => { indicator.style.display = 'none'; }, 2000);
            }, 2000);

        } catch (error) {
            console.error("Errore salvataggio da tabella generica:", error);
            indicator.textContent = 'Errore Salvataggio';
            indicator.className = 'save-notification error';
             setTimeout(() => { 
                indicator.style.opacity = '0';
                setTimeout(() => { indicator.style.display = 'none'; }, 3000);
            }, 3000);
        }
    }

    function aggiornaStileRiga(riga) {
        const { compagnia, key, index } = riga.dataset;
        const movimento = stato.datiCompleti[compagnia][key].movimenti[index];
        riga.className = '';

        if (movimento.incassato || movimento.abbuonoRegolato) {
            riga.classList.add('riga-incassato');
        } else {
            const [year, month, day] = key.split('-').map(Number);
            const dataMovimento = new Date(year, month - 1, day);
            const diffGiorni = Math.floor((new Date() - dataMovimento) / (1000 * 60 * 60 * 24));
            if (diffGiorni > 30) riga.classList.add('riga-critico');
            else if (diffGiorni > 15) riga.classList.add('riga-vecchio');
        }
    }

    function toggleAltraCompagniaInput(selectedValue) {
        const div = document.getElementById('altra-compagnia-div');
        div.style.display = (selectedValue === 'Altra') ? 'block' : 'none';
    }

    function apriFormAggiunta() {
        const formContainer = document.getElementById('add-movimento-form');
        formContainer.innerHTML = '';
        const config = configTabellaCorrente;
        document.getElementById('add-movimento-title').textContent = `Aggiungi a ${config.title}`;

        let specificHtml = '';
        let hasGenericImporto = true;

        const addCompagniaSelect = () => `
            <label>Compagnia:</label>
            <select id="add-compagnia" onchange="toggleAltraCompagniaInput(this.value)">
                <option>Allianz</option><option>HDI</option><option>Vittoria</option><option>ARAG</option><option>Helvetia</option>
                <option value="Altra">Altra Compagnia</option>
            </select>
            <div id="altra-compagnia-div" style="display:none;">
                <label>Nome Altra Compagnia:</label>
                <input type="text" id="add-altra-compagnia">
            </div>`;

        switch(config.type) {
            case 'anticipi':
                specificHtml += addCompagniaSelect();
                specificHtml += `
                    <label>Tipo Anticipo:</label>
                    <select id="add-tipoAnticipo">
                        <option>Anticipo Contanti</option><option>Anticipo Assegno</option><option>Anticipo POS</option>
                        <option>Anticipo Bonifico</option><option>Plafond</option><option>Sospeso Cassa</option>
                    </select>
                    <label>Anticipo di:</label><input type="text" id="add-anticipoDi">`;
                break;
            case 'bonifici_allianz':
                specificHtml += `<input type="hidden" id="add-compagnia" value="Allianz">`;
                break;
            case 'bonifici_hdi_arag':
            case 'pos_hdi_arag':
                 specificHtml += `
                    <label>Compagnia:</label>
                    <select id="add-compagnia"><option>HDI</option><option>ARAG</option></select>`;
                break;
            case 'abbuoni':
                hasGenericImporto = false;
                specificHtml += `<label>Importo Abbuono:</label><input type="number" id="add-abbuono" step="0.01" required>`;
                specificHtml += `<label>Effettuato da:</label><input type="text" id="add-personaAbbuono" required>`;
                specificHtml += addCompagniaSelect();
                break;
        }

        let formHtml = `
            <label>Data:</label><input type="date" id="add-data" required value="${formatDate(new Date())}">
            <label>Cliente:</label><input type="text" id="add-cliente" required>
            <label>Polizza:</label><input type="text" id="add-polizza">
            ${hasGenericImporto ? '<label>Importo:</label><input type="number" id="add-importo" step="0.01" required>' : ''}
            ${specificHtml}
            <label>Note:</label><input type="text" id="add-note">
        `;

        formContainer.innerHTML = formHtml;
        document.getElementById('add-movimento-modal').style.display = 'flex';
    }

    function processaFormAggiunta() {
        const config = configTabellaCorrente;
        const dataInput = document.getElementById('add-data');
        if (!dataInput.value) { alert('Per favore, inserisci una data.'); return; }

        const data = new Date(dataInput.valueAsDate);
        const dataKey = formatDate(data);
        let compagnia = document.getElementById('add-compagnia').value;
        if (compagnia === 'Altra') {
            compagnia = document.getElementById('add-altra-compagnia').value.trim();
            if (!compagnia) {
                alert('Per favore, inserisci il nome della compagnia.');
                return;
            }
        }
        
        const movimento = {
            metodologia: '',
            nomeCliente: document.getElementById('add-cliente').value,
            numeroPolizza: document.getElementById('add-polizza').value,
            importo: parseFloat(document.getElementById('add-importo')?.value) || 0,
            note: document.getElementById('add-note').value,
            isManuallyAdded: true
        };

        switch(config.type) {
            case 'anticipi':
                movimento.metodologia = 'Anticipo';
                movimento.tipoAnticipo = document.getElementById('add-tipoAnticipo').value;
                movimento.anticipoDi = document.getElementById('add-anticipoDi').value;
                break;
            case 'bonifici_allianz':
            case 'bonifici_hdi_arag':
                movimento.metodologia = 'Bonifico';
                break;
            case 'pos_hdi_arag':
                movimento.metodologia = 'POS';
                break;
            case 'abbuoni':
                movimento.abbuoni = parseFloat(document.getElementById('add-abbuono')?.value) || 0;
                movimento.personaAbbuono = document.getElementById('add-personaAbbuono')?.value;
                break;
        }

        if (!stato.datiCompleti[compagnia]) stato.datiCompleti[compagnia] = {};
        if (!stato.datiCompleti[compagnia][dataKey]) {
            const [year, month, day] = dataKey.split('-').map(Number);
            stato.datiCompleti[compagnia][dataKey] = creaNuovoGiorno(new Date(year, month-1, day));
        }
        if (!stato.datiCompleti[compagnia][dataKey].movimenti) stato.datiCompleti[compagnia][dataKey].movimenti = [];
        
        stato.datiCompleti[compagnia][dataKey].movimenti.push(movimento);
        document.getElementById('add-movimento-modal').style.display = 'none';
        mostraTabella(config.type);
        salvaTutteLeModificheTabella();
    }

    // ===============================================
    // FUNZIONI PER INCASSO MULTIPLO
    // ===============================================
    function calcolaImportoMultiplo() {
        const importoTot = parseFloat(document.getElementById('importo').value) || 0;
        const importo1 = parseFloat(document.getElementById('importoMultiplo1').value) || 0;
        document.getElementById('importoMultiplo2').value = (importoTot - importo1).toFixed(2);
    }
    
    function aggiornaCampiCondizionaliMultiplo(partNumber) {
        const metodologia = document.getElementById(`metodologiaMultiplo${partNumber}`).value;
        const container = document.getElementById(`campiCondizionaliMultiplo${partNumber}`);
        let html = '';

        if (metodologia === 'Assegno') {
            html = `<label>Numero Assegno:</label><input type="text" id="numeroAssegno_multiplo${partNumber}" placeholder="N° Assegno">`;
        } else if (metodologia === 'POS' && stato.compagniaSelezionata === 'Allianz') {
            html = `<label>Tipo POS:</label><select id="tipoPosAllianz_multiplo${partNumber}"><option>POS Direzione</option><option>POS Agenzia</option></select>`;
        }
        container.innerHTML = html;
    }
    
    function leggiCampiCondizionaliMultiplo(partNumber) {
        const metodologia = document.getElementById(`metodologiaMultiplo${partNumber}`).value;
        const dati = {};
        if (metodologia === 'Assegno') {
            dati.numeroAssegno = document.getElementById(`numeroAssegno_multiplo${partNumber}`).value;
        } else if (metodologia === 'POS' && stato.compagniaSelezionata === 'Allianz') {
            dati.tipoPosAllianz = document.getElementById(`tipoPosAllianz_multiplo${partNumber}`).value;
        }
        return dati;
    }

    // Rendi le funzioni visibili globalmente
    window.inizializzaApp = inizializzaApp;
    window.caricaGiornale = caricaGiornale;
    window.processaFormMovimento = processaFormMovimento;
    window.aggiornaCampiCondizionali = aggiornaCampiCondizionali;
    window.aggiungiCampoAssegnoConteggio = aggiungiCampoAssegnoConteggio;
    window.modificaMovimento = modificaMovimento;
    window.cancellaMovimento = cancellaMovimento;
    window.annullaModifica = annullaModifica;
    window.rendiProvvigioneEditabile = rendiProvvigioneEditabile;
    window.salvaProvvigioneModificata = salvaProvvigioneModificata;
    window.verificaChiusura = verificaChiusura;
    window.salvaDatiLocali = salvaDatiLocali;
    window.salvaStatoCorrente = salvaStatoCorrente;
    window.aggiornaTuttiRiepiloghi = aggiornaTuttiRiepiloghi;
    window.calcolaConteggioFisico = calcolaConteggioFisico;
    window.mostraTabella = mostraTabella;
    window.applicaFiltriTabella = applicaFiltriTabella;
    window.resetFiltriTabella = resetFiltriTabella;
    window.salvaModificaGenerica = salvaModificaGenerica;
    window.salvaTutteLeModificheTabella = salvaTutteLeModificheTabella;
    window.apriFormAggiunta = apriFormAggiunta;
    window.processaFormAggiunta = processaFormAggiunta;
    window.esportaBackup = esportaBackup;
    window.importaBackup = importaBackup;
    window.cancellaMovimentoGenerico = cancellaMovimentoGenerico;
    window.toggleAltraCompagniaInput = toggleAltraCompagniaInput;
    window.stampaPersonalizzata = stampaPersonalizzata;
    window.gestisciChiusuraFestiva = gestisciChiusuraFestiva;
    window.annullaChiusuraFestiva = annullaChiusuraFestiva;
    window.calcolaImportoMultiplo = calcolaImportoMultiplo;
    window.aggiornaCampiCondizionaliMultiplo = aggiornaCampiCondizionaliMultiplo;
    window.toggleRiportoMode = toggleRiportoMode;
    window.togglePersonaAbbuono = togglePersonaAbbuono;
</script>
</body>
</html>
