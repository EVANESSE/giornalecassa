<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa (Collaborativa)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* CSS COMPLETO - ORIGINALE + STILI LOGIN */
        :root {
            --primary-color: #6c757d;
            --primary-color-light: #f8f9fa;
            --primary-rgb: 108, 117, 125;
        }
        body.theme-allianz { --primary-color: #007bff; --primary-color-light: #cce5ff; --primary-rgb: 0, 123, 255; }
        body.theme-hdi { --primary-color: #28a745; --primary-color-light: #d4edda; --primary-rgb: 40, 167, 69; }
        body.theme-vittoria { --primary-color: #6f42c1; --primary-color-light: #e2d9f3; --primary-rgb: 111, 66, 193; }
        body.theme-arag { --primary-color: #ffc107; --primary-color-light: #fff3cd; --primary-rgb: 255, 193, 7; }
        body.theme-helvetia { --primary-color: #dc3545; --primary-color-light: #f8d7da; --primary-rgb: 220, 53, 69; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto; background: #fff; padding: 25px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;
        }
        h1, h2, h3 { color: var(--primary-color); }
        h1 { border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .box { padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; }

        input, select, button {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem;
        }
        button {
            background-color: var(--primary-color); color: white; border: none;
            cursor: pointer; font-weight: bold; transition: background-color 0.2s;
        }
        button.button-save { background-color: #28a745; font-size: 1.1rem; padding: 12px;}
        button:hover { filter: brightness(90%); }
        button:disabled, fieldset:disabled button { background-color: #ccc; cursor: not-allowed; }
        fieldset { border: none; padding: 0; margin: 0; }
        fieldset:disabled { opacity: 0.6; }
        .button-secondary { background-color: #6c757d; }
        .button-edit { background-color: #ffc107; color: #212529; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}
        .button-delete { background-color: #dc3545; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; table-layout: fixed; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; word-wrap: break-word; }
        th { background-color: var(--primary-color-light); }
        
        .riepilogo-totali, .risultato-verifica {
            font-size: 1.2rem; font-weight: bold; padding: 15px; margin-top: 15px;
            border-radius: 5px; background-color: var(--primary-color-light); border-left: 5px solid var(--primary-color);
        }
        .risultato-verifica.ok { color: #155724; background-color: #d4edda; border-left-color: #28a745; }
        .risultato-verifica.errore { color: #721c24; background-color: #f8d7da; border-left-color: #dc3545; }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; 
            justify-content: center; align-items: center; z-index: 1000;
        }
        
        #company-selector-modal .modal-content {
            background: linear-gradient(to bottom, #f8f9fa, #ffffff); border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 30px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #company-selector-modal .company-button {
            width: 300px; margin: 15px 0; font-weight: bold; padding: 30px 10px;
            border-bottom: 3px solid rgba(0,0,0,0.25); border-radius: 8px;
            transition: all 0.2s ease-in-out; font-size: 1.4rem;
        }
        #company-selector-modal .company-button:hover {
            transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.35); filter: brightness(1.1);
        }
        
        .utility-grid-container {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 20px; padding: 20px;
        }
        .utility-button {
            width: 150px; height: 105px; margin: 0; padding: 10px;
            border-radius: 15px; border: 1px solid #b0b0b0;
            font-size: 1rem; font-weight: bold; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 10px; cursor: pointer;
        }
        
        .app-header { 
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
            padding: 10px 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; gap: 20px;
        }
        .app-header .header-group { display: flex; align-items: center; gap: 10px; }

        .alert-box {
            display: none; border-radius: 10px; padding: 20px; margin-top: 20px;
            max-width: 90%; width: 800px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-height: 40vh; overflow-y: auto;
        }
        .alert-box h3 { margin-top: 0; } .alert-box ul { list-style: none; padding: 0; }
        .alert-box li { padding: 8px; border-bottom: 1px dotted #ccc; }
        #riattivazioni-alert-container { background-color: #fff3cd; color: #856404; }
        #promemoria-alert-container { background-color: #d1ecf1; color: #0c5460; }

        .modal-full { padding: 20px; align-items: flex-start; overflow-y: auto; }
        .modal-full .modal-content-full { width: 95%; max-width: 1800px; background: #fff; padding: 20px; border-radius: 8px; }
        .modal-toolbar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid #ccc; margin-bottom: 15px;}
        .modal-toolbar button { width: auto; margin-bottom: 0; }
        .generic-table td[contenteditable="true"]:hover { background-color: #fff3cd; cursor: text; }
        .generic-table input[type="checkbox"] { width: auto; transform: scale(1.2); }
        
        /* Stili per il Login */
        #auth-container { max-width: 400px; margin: 50px auto; padding: 40px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        #auth-container h1 { color: #333; margin-bottom: 20px; border-bottom: none; }
        #auth-container input { width: 100%; padding: 12px; margin-bottom: 15px; }
        #auth-container button { width: 100%; padding: 12px; font-size: 1.1rem; margin-bottom: 10px; }
        #auth-container .secondary-action { background-color: #6c757d; }
        #auth-error { color: red; margin-top: 15px; font-weight: bold; min-height: 20px; }
        .hidden { display: none; }
        #header-user-info { font-weight: bold; }
        #header-logout-button { width: auto; padding: 8px 15px; font-size: 0.9rem; }
        .modified-by { font-size: 0.75rem; color: #6c757d; display: block; }
    </style>
</head>
<body id="app-body">
    
    <div id="auth-container">
        <h1>Accesso Gestione Cassa</h1>
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button onclick="login()">Accedi</button>
            <button class="secondary-action" onclick="showRegisterForm()">Non hai un account? Registrati</button>
        </div>
        <div id="register-form" class="hidden">
            <input type="email" id="register-email" placeholder="Email" required>
            <input type="password" id="register-password" placeholder="Password (min. 6 caratteri)" required>
            <button onclick="registerUser()">Registrati</button>
            <button class="secondary-action" onclick="showLoginForm()">Hai gi√† un account? Accedi</button>
        </div>
        <p id="auth-error"></p>
    </div>

    <div id="app-container" class="hidden">
        <div class="modal-overlay" id="company-selector-modal">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="modal-wrapper" style="display: flex; gap: 40px;">
                    <div class="modal-content">
                        <h2>Seleziona la Compagnia</h2>
                        <button class="company-button" onclick="inizializzaApp('Allianz')" style="background-color:#007bff">Allianz</button>
                        <button class="company-button" onclick="inizializzaApp('HDI')" style="background-color:#28a745">HDI</button>
                        <button class="company-button" onclick="inizializzaApp('Vittoria')" style="background-color:#6f42c1">Vittoria</button>
                        <button class="company-button" onclick="inizializzaApp('ARAG')" style="background-color:#ffc107">ARAG</button>
                        <button class="company-button" onclick="inizializzaApp('Helvetia')" style="background-color:#dc3545">Helvetia</button>
                    </div>
                    <div class="modal-content">
                        <h2>Altre Funzioni</h2>
                        <div class="utility-grid-container">
                            <button class="utility-button" onclick="mostraTabella('anticipi')"><i class="fas fa-hand-holding-usd fa-2x"></i><span>ANTICIPO</span></button>
                            <button class="utility-button" onclick="mostraTabella('abbuoni')"><i class="fas fa-tags fa-2x"></i><span>ABBUONI</span></button>
                            <button class="utility-button" onclick="mostraTabella('bonifici_hdi_arag')"><i class="fas fa-university fa-2x"></i><span>BONIFICI HDI/ARAG</span></button>
                            <button class="utility-button" onclick="mostraTabella('pos_hdi_arag')"><i class="far fa-credit-card fa-2x"></i><span>POS HDI/ARAG</span></button>
                            <button class="utility-button" onclick="mostraTabella('bonifici_allianz')"><i class="fas fa-university fa-2x"></i><span>BONIFICI ALLIANZ</span></button>
                            <button class="utility-button" onclick="mostraTabella('bonifici_vittoria')"><i class="fas fa-university fa-2x"></i><span>BONIFICI VITTORIA</span></button>
                            <button class="utility-button" onclick="mostraTabella('riattivazioni_vittoria')"><i class="fas fa-calendar-check fa-2x"></i><span>RIATTIVAZIONI VITTORIA</span></button>
                            <button class="utility-button" onclick="mostraTabella('promemoria')"><i class="fas fa-bell fa-2x"></i><span>PROMEMORIA</span></button>
                        </div>
                    </div>
                </div>
                <div id="riattivazioni-alert-container" class="alert-box"></div>
                <div id="promemoria-alert-container" class="alert-box"></div>
            </div>
        </div>
        
        <div class="modal-overlay modal-full" id="generic-modal" style="display:none;">
            <div class="modal-content-full">
                <div class="modal-toolbar">
                    <h2 id="generic-modal-title"></h2>
                    <div class="action-group">
                        <button class="button-save" onclick="apriFormAggiunta()"><i class="fa fa-plus"></i> Aggiungi Manualmente</button>
                        <button class="button-secondary" onclick="document.getElementById('generic-modal').style.display = 'none'">Chiudi</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table id="generic-table" class="generic-table">
                       <thead></thead>
                       <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="add-item-modal" style="display:none; z-index: 1001;">
            <div class="modal-content" style="text-align: left; width: 450px; padding: 30px;">
                <h2 id="add-item-title">Aggiungi Voce Manuale</h2>
                <form id="add-item-form" onsubmit="event.preventDefault(); processaFormAggiunta();"></form>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="processaFormAggiunta()" class="button-save" style="width: 50%;">Salva</button>
                    <button type="button" class="button-secondary" style="width: 50%;" onclick="document.getElementById('add-item-modal').style.display = 'none'">Annulla</button>
                </div>
            </div>
        </div>

        <div class="container" id="main-container">
            <div class="app-header">
                <div class="header-group">
                    <h1 id="main-title">Registro Cassa</h1>
                </div>
                <div class="header-group">
                     <span id="header-user-info"></span>
                     <button onclick="logout()" id="header-logout-button" class="button-secondary">Esci</button>
                </div>
            </div>
            <div class="app-header">
                <div class="header-group">
                    <label for="date-selector">Visualizza movimenti del:</label>
                    <input type="date" id="date-selector" onchange="caricaGiornale(this.valueAsDate)">
                </div>
                <div class="header-group">
                    <button onclick="location.reload()">Cambia Compagnia</button>
                </div>
            </div>
            <div class="box" id="box-riepilogo-movimenti">
                <h2>Aggiungi / Modifica Movimento</h2>
                <form id="formMovimento" onsubmit="event.preventDefault(); processaFormMovimento();">
                    <input type="hidden" id="editingId">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="nomeCliente" placeholder="Nome Cliente" required>
                        <input type="text" id="numeroPolizza" placeholder="Numero Polizza">
                        <select id="metodologia" required></select>
                        <input type="number" id="importo" placeholder="Importo" step="0.01" required>
                    </div>
                    <div id="form-buttons">
                        <button type="submit">Aggiungi Movimento</button>
                    </div>
                </form>
                <hr>
                <h2>Riepilogo Movimenti di Cassa</h2>
                <table id="tabellaMovimenti">
                    <thead><tr>
                        <th>Cliente</th><th>Polizza</th><th>Metodo</th><th>Importo (‚Ç¨)</th><th>Azioni</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // ===============================================
    // ARCHITETTURA COLLABORATIVA - VERSIONE DEFINITIVA
    // ===============================================
    
    const firebaseConfig = {
      apiKey: "AIzaSyD41OqDrIwwH7PrK_ywmYRYVrR_KAehiU8",
      authDomain: "giornalecassa.firebaseapp.com",
      projectId: "giornalecassa",
      storageBucket: "giornalecassa.appspot.com",
      messagingSenderId: "655250052165",
      appId: "1:655250052165:web:8cead9e63e7dd951773f2c"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let stato = { compagniaSelezionata: null, dataSelezionata: null };
    let unsubscribeListeners = {};
    let currentTableConfig = null;

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('header-user-info').textContent = `Utente: ${user.email}`;
            document.getElementById('company-selector-modal').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            setupGlobalListeners();
        } else {
            currentUser = null;
            appContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
            Object.values(unsubscribeListeners).forEach(unsub => unsub());
            unsubscribeListeners = {};
        }
    });

    function login() { /* ... implementazione standard ... */ }
    function registerUser() { /* ... implementazione standard ... */ }
    function logout() { auth.signOut(); }
    function showRegisterForm() { /* ... implementazione standard ... */ }
    function showLoginForm() { /* ... implementazione standard ... */ }

    function inizializzaApp(compagnia) {
        stato.compagniaSelezionata = compagnia;
        document.body.className = `theme-${compagnia.toLowerCase()}`;
        document.getElementById('company-selector-modal').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        document.getElementById('main-title').textContent = `Registro Cassa ${compagnia}`;
        
        const selectMetodo = document.getElementById('metodologia');
        selectMetodo.innerHTML = `<option value="" disabled selected>Metodologia</option><option value="Contanti">Contanti</option><option value="Assegno">Assegno</option><option value="POS">POS</option><option value="Bonifico">Bonifico</option><option value="Anticipo">Anticipo</option><option value="Abbuono">Abbuono</option>`;

        document.getElementById('date-selector').valueAsDate = new Date();
        caricaGiornale(new Date());
    }

    function caricaGiornale(data) {
        if (!data) return;
        stato.dataSelezionata = data;
        const dataKey = formatDate(data);

        if (unsubscribeListeners.movimenti) unsubscribeListeners.movimenti();
        
        unsubscribeListeners.movimenti = db.collection('movimenti')
            .where('compagnia', '==', stato.compagniaSelezionata)
            .where('data', '==', dataKey)
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
                const movimenti = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                aggiornaTabellaMovimenti(movimenti);
            });
    }

    async function processaFormMovimento() {
        if (!currentUser) return;
        const editingId = document.getElementById('editingId').value;
        const movimento = {
            nomeCliente: document.getElementById('nomeCliente').value,
            numeroPolizza: document.getElementById('numeroPolizza').value,
            importo: parseFloat(document.getElementById('importo').value) || 0,
            metodologia: document.getElementById('metodologia').value,
            compagnia: stato.compagniaSelezionata,
            data: formatDate(stato.dataSelezionata),
            updatedBy: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (editingId) {
                await db.collection('movimenti').doc(editingId).update(movimento);
            } else {
                movimento.createdBy = currentUser.email;
                movimento.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('movimenti').add(movimento);
            }
            annullaModifica();
        } catch (error) { console.error("Errore salvataggio:", error); }
    }

    function aggiornaTabellaMovimenti(movimenti) {
        const tbody = document.getElementById('tabellaMovimenti').querySelector('tbody');
        tbody.innerHTML = '';
        movimenti.forEach(m => {
            const riga = tbody.insertRow();
            const modificheInfo = m.updatedBy ? `<span class="modified-by">Mod. da: ${m.updatedBy.split('@')[0]}</span>` : '';
            riga.innerHTML = `
                <td>${m.nomeCliente || ''} ${modificheInfo}</td>
                <td>${m.numeroPolizza || ''}</td>
                <td>${m.metodologia || ''}</td>
                <td>${(m.importo || 0).toFixed(2)}</td>
                <td>
                    <button class="button-edit" onclick="modificaMovimento('${m.id}')">Modifica</button>
                    <button class="button-delete" onclick="cancellaMovimento('${m.id}')">Elimina</button>
                </td>
            `;
        });
    }

    function modificaMovimento(id) {
        db.collection('movimenti').doc(id).get().then(doc => {
            if (!doc.exists) return;
            const m = doc.data();
            document.getElementById('editingId').value = id;
            document.getElementById('nomeCliente').value = m.nomeCliente;
            document.getElementById('numeroPolizza').value = m.numeroPolizza;
            document.getElementById('importo').value = m.importo;
            document.getElementById('metodologia').value = m.metodologia;
            document.getElementById('form-buttons').innerHTML = `<button type="submit">Salva Modifiche</button><button type="button" class="button-secondary" onclick="annullaModifica()">Annulla</button>`;
        });
    }

    async function cancellaMovimento(id) {
        if (confirm('Sei sicuro?')) {
            await db.collection('movimenti').doc(id).delete();
        }
    }
    
    function annullaModifica() {
        document.getElementById('editingId').value = "";
        document.getElementById('formMovimento').reset();
        document.getElementById('metodologia').value = "";
        document.getElementById('form-buttons').innerHTML = `<button type="submit">Aggiungi Movimento</button>`;
    }

    function formatDate(date) { return date.toISOString().split('T')[0]; }

    // --- LOGICA "ALTRE FUNZIONI" ---
    const configsTabelle = {
        'anticipi': { title: 'Gestione Anticipi', filter: ['Anticipo'], columns: ['data', 'compagnia', 'nomeCliente', 'importo'], formFields: ['data', 'compagnia', 'nomeCliente', 'importo'] },
        'abbuoni': { title: 'Gestione Abbuoni', filter: ['Abbuono'], columns: ['data', 'compagnia', 'nomeCliente', 'importo'], formFields: ['data', 'compagnia', 'nomeCliente', 'importo'] },
        'bonifici_allianz': { title: 'Bonifici Allianz', filter: ['Bonifico'], companyFilter: 'Allianz', columns: ['data', 'nomeCliente', 'importo'], formFields: ['data', 'nomeCliente', 'importo'] },
        'bonifici_hdi_arag': { title: 'Bonifici HDI/ARAG', filter: ['Bonifico'], companyFilter: ['HDI', 'ARAG'], columns: ['data', 'compagnia', 'nomeCliente', 'importo'], formFields: ['data', 'compagnia', 'nomeCliente', 'importo'] },
        'bonifici_vittoria': { title: 'Bonifici Vittoria', filter: ['Bonifico'], companyFilter: 'Vittoria', columns: ['data', 'nomeCliente', 'importo'], formFields: ['data', 'nomeCliente', 'importo'] },
        'pos_hdi_arag': { title: 'POS HDI/ARAG', filter: ['POS'], companyFilter: ['HDI', 'ARAG'], columns: ['data', 'compagnia', 'nomeCliente', 'importo'], formFields: ['data', 'compagnia', 'nomeCliente', 'importo'] },
        'riattivazioni_vittoria': { title: 'Riattivazioni Vittoria', collection: 'riattivazioni_vittoria', columns: {contraente: 'Contraente', nPolizza: 'N¬∞ Polizza', dataSospensione: 'Sospeso il', dataRiattivazione: 'Riattivare il', riattivata: 'OK?'}, formFields: {contraente: 'text', nPolizza: 'text', dataSospensione: 'date', dataRiattivazione: 'date'} },
        'promemoria': { title: 'Promemoria', collection: 'promemoria', columns: {data: 'Data', utente: 'Utente', nota: 'Nota', fatto: 'OK?'}, formFields: {data: 'date', utente: 'text', nota: 'textarea'} }
    };

    function mostraTabella(type) {
        currentTableConfig = { type, ...configsTabelle[type] };
        const config = currentTableConfig;
        document.getElementById('generic-modal-title').textContent = config.title;
        
        let query;
        if (config.collection) {
            query = db.collection(config.collection).orderBy('createdAt', 'desc');
        } else {
            query = db.collection('movimenti').where('metodologia', 'in', config.filter);
            if (config.companyFilter) {
                const companies = Array.isArray(config.companyFilter) ? config.companyFilter : [config.companyFilter];
                query = query.where('compagnia', 'in', companies);
            }
            query = query.orderBy('createdAt', 'desc');
        }

        if (unsubscribeListeners[type]) unsubscribeListeners[type]();
        unsubscribeListeners[type] = query.onSnapshot(snapshot => {
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            popolaTabellaGenerica(items);
        });
        document.getElementById('generic-modal').style.display = 'flex';
    }

    function popolaTabellaGenerica(items) {
        const config = currentTableConfig;
        const table = document.getElementById('generic-table');
        const columnKeys = Array.isArray(config.columns) ? config.columns : Object.keys(config.columns);
        const columnHeaders = Array.isArray(config.columns) ? config.columns : Object.values(config.columns);
        
        table.querySelector('thead').innerHTML = `<tr>${columnHeaders.map(h => `<th>${h}</th>`).join('')}<th>Azioni</th></tr>`;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        items.forEach(item => {
            const riga = tbody.insertRow();
            let cellsHtml = '';
            columnKeys.forEach(key => {
                let content = item[key] || '';
                if (typeof content === 'boolean') {
                    content = `<input type="checkbox" ${content ? 'checked' : ''} onchange="updateGenericItem('${item.id}', '${key}', this.checked)">`;
                }
                cellsHtml += `<td>${content}</td>`;
            });
            riga.innerHTML = `${cellsHtml}<td><button class="button-delete" onclick="cancellaItemGenerico('${item.id}')">X</button></td>`;
        });
    }
    
    function apriFormAggiunta() {
        const config = currentTableConfig;
        document.getElementById('add-item-title').textContent = `Aggiungi ${config.title}`;
        const form = document.getElementById('add-item-form');
        form.innerHTML = '';
        
        const fields = Array.isArray(config.formFields) ? config.formFields.reduce((obj, key) => ({...obj, [key]: 'text'}), {}) : config.formFields;

        for (const key in fields) {
            const type = fields[key];
            if (type === 'textarea') {
                form.innerHTML += `<label>${key}</label><textarea id="form-${key}"></textarea>`;
            } else {
                form.innerHTML += `<label>${key}</label><input type="${type}" id="form-${key}">`;
            }
        }
        document.getElementById('add-item-modal').style.display = 'flex';
    }

    async function processaFormAggiunta() {
        if (!currentUser) return;
        const config = currentTableConfig;
        const newItem = { createdBy: currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        
        const fields = Array.isArray(config.formFields) ? config.formFields : Object.keys(config.formFields);
        fields.forEach(key => {
            newItem[key] = document.getElementById(`form-${key}`).value;
        });

        const collectionName = config.collection || 'movimenti';
        if (!config.collection) { // Se √® derivato, assegnamo la metodologia giusta
            newItem.metodologia = config.filter[0]; 
        }

        await db.collection(collectionName).add(newItem);
        document.getElementById('add-item-modal').style.display = 'none';
    }

    async function cancellaItemGenerico(id) {
        if (!confirm('Sicuro?')) return;
        const collectionName = currentTableConfig.collection || 'movimenti';
        await db.collection(collectionName).doc(id).delete();
    }

    async function updateGenericItem(id, key, value) {
        const collectionName = currentTableConfig.collection || 'movimenti';
        const updateData = { [key]: value };
        await db.collection(collectionName).doc(id).update(updateData);
    }

    function setupGlobalListeners() {
        const today = formatDate(new Date());
        const createAlertListener = (collectionName, containerId, title, formatter) => {
            const dateField = collectionName === 'riattivazioni_vittoria' ? 'dataRiattivazione' : 'data';
            if (unsubscribeListeners[collectionName]) unsubscribeListeners[collectionName]();
            unsubscribeListeners[collectionName] = db.collection(collectionName).where(dateField, '==', today)
                .onSnapshot(snapshot => {
                    const container = document.getElementById(containerId);
                    if (snapshot.empty) { container.style.display = 'none'; return; }
                    let listHtml = `<h3>${title}</h3><ul>`;
                    snapshot.forEach(doc => listHtml += `<li>${formatter(doc.data())}</li>`);
                    container.innerHTML = `${listHtml}</ul>`;
                    container.style.display = 'block';
                });
        };
        createAlertListener('promemoria', 'promemoria-alert-container', '<i class="fas fa-bell"></i> Promemoria di Oggi', item => `Per <strong>${item.utente}</strong>: ${item.nota}`);
        createAlertListener('riattivazioni_vittoria', 'riattivazioni-alert-container', '<i class="fas fa-calendar-check"></i> Riattivazioni Vittoria di Oggi', item => `<strong>${item.contraente}</strong> - Polizza ${item.nPolizza || 'N/D'}`);
    }
    
    Object.assign(window, {
        login, registerUser, logout, showLoginForm, showRegisterForm,
        inizializzaApp, caricaGiornale, processaFormMovimento, modificaMovimento, cancellaMovimento, annullaModifica,
        mostraTabella, apriFormAggiunta, processaFormAggiunta, cancellaItemGenerico, updateGenericItem, formatDate
    });

</script>
</body>
</html>
